# 13.1 Part-Time Lesson Plan: Object Relational Mapping (ORM)

## Overview 

In today's class, students will be introduced to the Sequelize ORM. They will work with a Book model and use Sequelize's CRUD methods within Express.js routes. Students will also use `async / await` syntax to create a synchronous seeds script.

## Instructor Notes

* Complete activities `01-Ins_Sequelize-Setup` through `10-Stu_Async-Await`

* You will be using MySQL for today's activities. Be sure to have your MySQL server up and running. Go ahead and create the `library_db` database ahead of time, or demonstrate it live in class.

* The first activity, `01-Ins_Sequelize-Setup`, hardcodes the database credentials in the `connection.js` file. Every subsequent activity uses a `.env` file. Make sure you create one or rename the existing `.env.EXAMPLE` file before demonstrating each activity.

* All of the activities will be using Insomnia Core to test the routes, instead of relying on a front end. Be sure to have it installed and ready for all activities.

* Activities `05-Ins_Create` through `08-Stu_Update-Delete` include a `/seed` POST route to make it easier to populate the database with books. Starting from activity `09-Ins_Async-Await`, we switch to using a proper seed script in the `seeds` directory.

* To demo the mini project, you'll need to create a `traveller_db` database. Use the `seed.js` file located in `28-Stu_Mini-Project/Main/seeds` to populate the database before the demo.

* Remind students to do a `git pull` of the class repo to have today's activities ready and open in VS Code. 

* If you are comfortable doing so, live code the solutions to the activities. If not, no worries. Use the solutions provided and follow the prompts and talking points for review. 

* Let students know that the Bonus for each activity is meant to give them "food for thought". Rather than extra coding practice, it is a self-study on related topics that are beyond the scope of this unit for those who want to dig deeper and further their knowledge on this topic.

## Learning Objectives

By the end of class, students will be able to:

* Connect to a database using Sequelize and environment variables

* Create and configure a Sequelize model

* Perform CRUD operations with Sequelize methods

* Write a script to seed a database with initial data

* Convert asynchronous code to synchronous code using `async / await`

## Slide Deck

* [Unit 13 Slide Deck](https://docs.google.com/presentation/d/1_0n8JjM6cgmDyUfqGC6crF47JItD0mn9vzvQeYqZ5OE/)

## Time Tracker
| Start  | #   | Activity Name                       | Duration |
|---     |---  |---                                  |---       |
| 6:30PM | 1   | Instructor Do: Stoke Curiosity      | 0:10     |
| 6:40PM | 2   | Instructor Demo: Sequelize Setup    | 0:05     |
| 6:45PM | 3   | Student Do: Sequelize Setup         | 0:15     |
| 7:00PM | 4   | Instructor Review: Sequelize Setup  | 0:10     |
| 7:10PM | 5   | Instructor Demo: Models             | 0:05     |
| 7:15PM | 6   | Student Do: Models                  | 0:15     |
| 7:30PM | 7   | Instructor Review: Models           | 0:10     |
| 7:40PM | 8   | Instructor Demo: Create             | 0:05     |
| 7:45PM | 9   | Student Do: Create Read             | 0:15     |
| 8:00PM | 10  | BREAK                               | 0:15     |
| 8:15PM | 11  | Instructor Review: Create Read      | 0:10     |
| 8:25PM | 12  | Instructor Demo: Update Delete      | 0:05     |
| 8:30PM | 13  | Student Do: Update Delete           | 0:15     |
| 8:45PM | 14  | Instructor Review: Update Delete    | 0:10     |
| 8:55PM | 15  | Instructor Demo: Async Await        | 0:05     |
| 9:00PM | 16  | Student Do: Async Await             | 0:15     |
| 9:15PM | 17  | Instructor Review: Async Await      | 0:15     |
| 9:30PM | 18  | END                                 | 0:00     |

---

## Class Instruction

### 1. Instructor Do: Stoke Curiosity (10 min)

* Welcome students to class.

* Open the [slide deck](https://docs.google.com/presentation/d/1_0n8JjM6cgmDyUfqGC6crF47JItD0mn9vzvQeYqZ5OE/) and follow these prompts on their corresponding slides:

  * **Object Relational Mapping**
  
    * This unit is all about using Object Relational Mappers, or ORMs, to model your database data on the JavaScript side

  * **What are some of the challenges with using plain SQL in JavaScript?**
  
    * Prone to accidental syntax errors

    * Complicated queries can be hard to follow

    * Requires extra work to validate and secure data

    * Similar routes can lead to repetitive queries being written

    * Data relationships aren't obvious just by looking at the code
  
  * **What is Object-Oriented Programming?**

    * Code is organized using objects instead of functions

    * Objects can inherit properties and methods from other objects

    * Multiple objects can be created from the same blueprint classes or constructor functions
  
  * **How could objects help us manage SQL queries in JavaScript?**
  
    * Object methods could be set up to run generic SQL queries based on the methodâ€™s parameters

    * Objects could be structured to mimic how the data is stored in the database, eliminating ambiguity

    * Objects could be imported into any other module that needs to execute its SQL queries
  
  * **Is there a library that might already do this for us?**
  
    * Of course there is! Sequelize is an Object Relational Mapper (ORM) that can be installed with npm. It provides the following benefits:

      * Allows you to model your data as JavaScript classes 

      * Abstracts SQL queries to simpler object methods

      * Provides built-in validation checks for securing data

      * Makes it easier to visualize and join relational data

      * And more!
  
  * **How can we learn to use and implement Sequelize?**

    * Sequelize and other ORMs were created to make managing and using data easier, but they still come with a learning curve!

    * You can try the following strategies to learn Sequelize:

      * Read the official documentation and practice with the provided examples.

      * Reverse-engineer finished code to see how something was accomplished.

      * Build something from scratch.

      * Debug a broken app.

      * And most importantly, ask questions!
  
  * **Mini Project**

    * The mini project for this unit uses Sequelize to manage the data for a set of travel-related API routes

* Navigate to `28-Stu_Mini-Project/Main` in your command line.

* If you haven't already, rename the `.env.EXAMPLE` file and fill in your credentials. Use the `seeds/seed.js` script to populate the database with test data.

* Run `npm start` from the command line to start the server.

* Open Insomnia Core and demonstrate the following:

  * We can make a GET request to `http://localhost:3001/api/travellers` to see all travellers in the database.

  * We can make a GET request to `http://localhost:3001/api/locations` to see all locations in the database.

  * We can make a POST request to `http://localhost:3001/api/trips` with the following JSON to create a new relationship between traveller and location:

    ```json
    {
      "traveller_id": 1,
      "location_id": 1,
      "trip_budget": 2000
    }
    ```

  * We can make a GET request to `http://localhost:3001/api/travellers/1` to see the traveller with their related trip information included.

  * We are using Sequelize on the back end to manage all of this data and track how one dataset relates to another.

* Ask the class the following questions (â˜ï¸) and call on students for the answers (ğŸ™‹):

  * â˜ï¸ What are we learning?

  * ğŸ™‹ Sequelize, object relational mapping, data management, etc.

  * â˜ï¸ How does this project build off or extend previously learned material?

  * ğŸ™‹ We are continuing to use SQL and databases but will focus on a more object-oriented approach.

  * â˜ï¸ How does this project relate to your career goals?

  * ğŸ™‹ Big apps have complex data and require better ways to manage and visualize how the pieces connect.

* Answer any questions before proceeding to the next activity.

### 2. Instructor Demo: Sequelize Setup (5 min) 

* Open `01-Ins_Sequelize-Setup/package.json` in your IDE and explain the following:

  * ğŸ”‘ We include `sequelize` as a dependency. We also include `mysql2` to specify which flavor of SQL the Sequelize library should use.

    ```json
    "dependencies": {
      "express": "^4.17.1",
      "mysql2": "^2.2.5",
      "sequelize": "^6.3.5"
    }
    ```

* Run `npm install` in the `01-Ins_Sequelize-Setup` directory from the command line to demonstrate installing the dependencies.

* Open `01-Ins_Sequelize-Setup/config/connection.js` in your IDE and explain the following:

  * ğŸ”‘ We use the `Sequelize()` constructor to create a new database connection, specifying the user credentials and location of the MySQL database.

    ```js
    const sequelize = new Sequelize(
      // Database name
      'library_db',
      // User
      'root',
      // Password
      'myPassword',
      {
        // Database location
        host: 'localhost',
        dialect: 'mysql',
        port: 3306
      }
    );
    ```

  * Change the credentials to match your own before moving on.

* Open `01-Ins_Sequelize-Setup/server.js` in your IDE and explain the following:

  * ğŸ”‘ We import the connection object.

    ```js
    const sequelize = require('./config/connection');
    ```
  
  * ğŸ”‘ We use the `sync()` method to connect to the database.

    ```js
    sequelize.sync().then(() => {
      app.listen(PORT, () => console.log('Now listening'));
    });
    ```

* Run `npm start` in the `01-Ins_Sequelize-Setup` directory from the command line and demonstrate the following: 

  * ğŸ”‘ Sequelize executes a simple test query to verify the database connection.

    ```text
    Executing (default): SELECT 1+1 AS result
    Now listening
    ```

* Ask the class the following questions (â˜ï¸) and call on students for the answers (ğŸ™‹):

  * â˜ï¸ What dependencies are needed to set up Sequelize?

  * ğŸ™‹ The `sequelize` and `mysql2` npm packages.

  * â˜ï¸ How would we connect to a different database?

  * ğŸ™‹ Change the credentials in the `Sequelize()` constructor in `connection.js`.

  * â˜ï¸ Why would hardcoding these credentials be a bad idea?

  * ğŸ™‹ Other team members would have different credentials. If the repository is public, anyone can see the credentials.

* Answer any questions before proceeding to the next activity.

* In preparation for the activity, ask TAs to start directing students to the activity instructions found in `02-Stu_Sequelize-Setup/README.md`.

### 3. Student Do: Sequelize Setup (15 min) 

* Direct students to the activity instructions found in `02-Stu_Sequelize-Setup/README.md`.

* Break your students into pairs that will work together on this activity.

  ```md
  # ğŸ“– Replace Hard-Coded Credentials With Environment Variables

  Work with a partner to implement the following user story:

  * As a developer, I want to protect my database credentials by not hard-coding them in the project files.

  ## Acceptance Criteria

  * It's done when the database name, user, and password are moved to environment variables.

  * It's done when Sequelize is able to connect to the database using the `dotenv` npm package.

  ## ğŸ“ Note(s)

  Refer to the documentation: 

  * [dotenv npm package](https://www.npmjs.com/package/dotenv)

  ---

  ## ğŸ’¡ Hint(s)

  * How does the `dotenv` npm package use `.env` files?

  ## ğŸ† Bonus

  * If you have fully completed the above tasks, here is something you and your partner can work through as an added challenge to further your knowledge:

    * How can you set environment variables from the command line? 

  * Use [Google](https://www.google.com) or another search engine to research the above.
  ```

* While breaking everyone into groups, be sure to remind students and the rest of the instructional staff that questions on Slack or otherwise are welcome and will be handled. It's a good way for your team to prioritize students that need extra help while circulating through room.

### 4. Instructor Review: Sequelize Setup (10 min) 

* Ask the class the following questions (â˜ï¸) and call on students for the answers (ğŸ™‹):

  * â˜ï¸ How comfortable do you feel with the `dotenv` package and connecting to Sequelize? (Poll via Fist to Five, Slack, or Zoom)

* Assure students that we will cover the solution to help solidify their understanding. If questions remain, remind them to use office hours to get extra help!

* Use the prompts and talking points below to review the following key (ğŸ”‘) points:

  * âœ”ï¸ `.env` files

  * âœ”ï¸ `dotenv` npm package

* Open `02-Stu_Sequelize-Setup/Solved/package.json` in your IDE and explain the following: 

  * ğŸ”‘ We added the `dotenv` npm package as a dependency.

    ```json
    "dependencies": {
      "dotenv": "^8.2.0",
      "express": "^4.17.1",
      "mysql2": "^2.2.5",
      "sequelize": "^6.3.5"
    }
    ```

* Open `02-Stu_Sequelize-Setup/Solved/.env.EXAMPLE` in your IDE and explain the following: 

  * ğŸ”‘ We created a `.env` file to store our environment variables.

    ```text
    DB_NAME=library_db
    DB_PASSWORD=
    DB_USER=
    ```

* Fill in your credentials and rename the `.env.EXAMPLE` file to `.env` while explaining the following:

  * We called the file `.env.EXAMPLE` for activity purposes, but in actual projects it would just be `.env`.

* Open `02-Stu_Sequelize-Setup/Solved/.gitignore` in your IDE and explain the following: 

  * ğŸ”‘ We added `.env` to the `.gitignore` file to ensure our credentials don't accidentally get added and committed to the repository.

    ```text
    node_modules
    .DS_Store
    .env
    ```

* Open `02-Stu_Sequelize-Setup/Solved/config/connection.js` in your IDE and explain the following: 

  * ğŸ”‘ We imported the `dotenv` module and immediately executed its `config()` method, which allows our `.env` variables to be read by the Node.js script.

    ```js
    require('dotenv').config();
    ```

  * ğŸ”‘ We used `process.env` environment variables in place of hardcoded values to connect to the database.

    ```js
    const sequelize = new Sequelize(
      process.env.DB_NAME,
      process.env.DB_USER,
      process.env.DB_PASSWORD,
      {
        host: 'localhost',
        dialect: 'mysql',
        port: 3306
      }
    );
    ```

* Run `npm install` and `npm start` in the `02-Stu_Sequelize-Setup/Solved` directory from the command line and demonstrate the following:

  * Sequelize is still able to connect to the database using the `process.env` variables.

* Ask the class the following questions (â˜ï¸) and call on students for the answers (ğŸ™‹):

  * â˜ï¸ What problem does the `dotenv` package solve?

  * ğŸ™‹ It gives you a way to avoid hardcoding your credentials in a JS file.

  * â˜ï¸ Going forward, which activities will need to be set up with `dotenv`?

  * ğŸ™‹ Any activity that is using personal credentials.

  * â˜ï¸ What can we do if we don't completely understand this?

  * ğŸ™‹ We can refer to supplemental material, read the [dotenv npm package documentation](https://www.npmjs.com/package/dotenv) and [Sequelize documentation](https://sequelize.org/), and stick around for Office Hours to ask for help.

* Answer any questions before proceeding to the next activity.

### 5. Instructor Demo: Models (5 min) 

* Change the `03-Ins_Models/.env.EXAMPLE` file into your own `.env` file with your credentials.

* Run `npm install` and `npm start` in the `03-Ins_Models` directory from the command line and demonstrate the following:

  * ğŸ”‘ Sequelize executed a SQL `CREATE TABLE` statement when the `sync()` method was called.

  * ğŸ”‘ Sequelize performed this table creation based on a data model.

* Open `03-Ins_Models/models/Book.js` in your IDE and explain the following:

  * ğŸ”‘ Sequelize models are defined as JavaScript classes.

    ```js
    class Book extends Model {}
    ```

  * ğŸ”‘ The `init()` method allows us to define which properties the model has. These properties will become the table columns in MySQL.

    ```js
    Book.init(
      {
        title: {
          type: DataTypes.STRING
        },
        author: {
          type: DataTypes.STRING
        },
        isbn: {
          type: DataTypes.STRING
        },
        pages: {
          type: DataTypes.INTEGER
        },
        edition: {
          type: DataTypes.INTEGER
        },
        isPaperback: {
          type: DataTypes.BOOLEAN
        }
      }
    );
    ```

  * ğŸ”‘ We did not need to specify an `id` field, because Sequelize will generate a primary key automatically. In the future, however, it would be better to define it ourselves so we can retain more control over our model.

  * ğŸ”‘ We pass a second object to the `init()` method to link the model to the `sequelize` connection object, which is required for the model to work. We can optionally define other settings in this same object.

    ```js
    {
      sequelize,
      timestamps: false,
      underscored: true,
      modelName: 'book'
    }
    ```

  * For instance, `timestamps: false` stops Sequelize from auto-creating date columns in the MySQL table. We can also enforce column names to be underscored instead of camelCase.

* Open `03-Ins_Models/server.js` in your IDE and explain the following:

  * ğŸ”‘ We imported the model in the application to ensure Sequelize sees it and syncs it with the database.

    ```js
    const Book = require('./models/Book');
    ```

  * ğŸ”‘ In the `sync()` method, we added a `force: true` option to tell Sequelize to drop the tables if they exist and recreate them. This is helpful when you are still experimenting with your models.

    ```js
    sequelize.sync({ force: true }).then(() => {
      app.listen(PORT, () => console.log('Now listening'));
    });
    ```

* Reopen `03-Ins_Models/models/Book.js` and set `timestamps` to  `true`. Run `npm start` in the `03-Ins_Models` directory from the command line to demonstrate the following:

  * Sequelize executed a `DROP TABLE IF EXISTS` statement due to the `force: true` flag.

  * Sequelize included `created_at` and `updated_at` fields in the `CREATE TABLE` statement due to the `timestamps: true` flag.

* Ask the class the following questions (â˜ï¸) and call on students for the answers (ğŸ™‹):

  * â˜ï¸ How are Sequelize models written?

  * ğŸ™‹ As JavaScript classes

  * â˜ï¸ What does the model become when Sequelize syncs with the database?

  * ğŸ™‹ A MySQL table

  * â˜ï¸ Why would you want to remove the `force: true` flag before deploying?

  * ğŸ™‹ Removing `force: true` ensures that the database will not be dropped and that the stored data will not be lost.

* Answer any questions before proceeding to the next activity.

* In preparation for the activity, ask TAs to start directing students to the activity instructions found in `04-Stu_Models/README.md`.

### 6. Student Do: Models (15 min) 

* Direct students to the activity instructions found in `04-Stu_Models/README.md`.

* Break your students into pairs that will work together on this activity.

  ```md
  # ğŸ› MySQL Table isn't Being Created to Specifications

  Work with a partner to resolve the following issue(s):

  * As a developer, I want a MySQL table with the same name as the Sequelize model.

  * As a developer, I want a more descriptive primary key name in the MySQL table.

  ## Expected Behavior

  When Sequelize syncs the model with the database, the table name should be `book` (singular) and the primary key named `book_id`.

  ## Actual Behavior

  The table name is `books`, and the primary key is `id`.

  ## Steps to Reproduce the Problem

  1. Run `npm start` from the command line to start the server and sync the database.

  2. Run `mysql -u root -p` to log into the MySQL shell.

  3. In the MySQL shell, run `USE library_db;` to switch to the library database.

  4. Try to run `DESCRIBE book;`, and it will fail, because the table name is `books`.

  5. Run `DESCRIBE books;` and note that the primary key is named `id` and not `book_id`.

  ---

  ## ğŸ’¡ Hint(s)

  * What options does Sequelize provide when it comes to naming tables and fields?

  ## ğŸ† Bonus

  * If you have fully completed the above tasks, here is something you and your partner can work through as an added challenge to further your knowledge:

    * How can we apply model-based rules to all models in the Sequelize connection logic?

  * Use [Google](https://www.google.com) or another search engine to research the above.
  ```

* While breaking everyone into groups, be sure to remind students and the rest of the instructional staff that questions on Slack or otherwise are welcome and will be handled. It's a good way for your team to prioritize students that need extra help while circulating through room.

### 7. Instructor Review: Models (10 min) 

* Ask the class the following questions (â˜ï¸) and call on students for the answers (ğŸ™‹):

  * â˜ï¸ How comfortable do you feel with Sequelize models? (Poll via Fist to Five, Slack, or Zoom)

* Assure students that we will cover the solution to help solidify their understanding. If questions remain, remind them to use office hours to get extra help!

* Use the prompts and talking points below to review the following key (ğŸ”‘) points:

  * âœ”ï¸ Sequelize column options

  * âœ”ï¸ Sequelize table options

* Open `04-Stu_Models/Solved/models/Book.js` in your IDE and explain the following: 

  * ğŸ”‘ We added a `book_id` column with `primaryKey` and `autoIncrement` properties to replace Sequelize's auto-generated `id`.

    ```js
    book_id: {
      type: DataTypes.INTEGER,
      primaryKey: true,
      autoIncrement: true
    }
    ```

  * ğŸ”‘ In the configuration object, we added a `freezeTableName` property to prevent Sequelize from pluralizing the model name for the table name.

    ```js
    {
      sequelize,
      timestamps: false,
      freezeTableName: true,
      underscored: true,
      modelName: 'book'
    }
    ```

* Ask the class the following questions (â˜ï¸) and call on students for the answers (ğŸ™‹):

  * â˜ï¸ Why would we want to override Sequelize's default behavior?

  * ğŸ™‹ To remove any confusion around what we define and what Sequelize creates (e.g., the names we define won't suddenly change on us)

  * â˜ï¸ What can we do if we don't completely understand this?

  * ğŸ™‹ We can refer to supplemental material, read the [Sequelize docs on models](https://sequelize.org/master/manual/model-basics.html), and stick around for Office Hours to ask for help.

* Answer any questions before proceeding to the next activity.

### 8. Instructor Demo: Create (5 min) 

* Rename the `05-Ins_Create/.env.EXAMPLE` file to `.env` and fill in your credentials.

* Navigate to `05-Ins_Create` and run `npm install` and `npm start` from the command line to demonstrate the following in Insomnia Core:

  * We can make a POST request to `http://localhost:3001/api/books/` to create a single book with the following JSON:

    ```json
    {
      "title": "Don't Make Me Think",
      "author": "Steve Krug",
      "is_paperback": true
    }
    ```

  * We can also make a POST request to `http://localhost:3001/api/books/seed` to create multiple books at once.

* Open `05-Ins_Create/routes/api/bookRoutes.js` in your IDE and explain the following:

  * ğŸ”‘ We imported the `Book` model so our Express.js routes can perform queries on it.

    ```js
    const Book = require('../../models/Book');
    ```

  * ğŸ”‘ In the POST route, we use the model's `create()` method to create a new book record in the database.

    ```js
    router.post('/', (req, res) => {
      Book.create({
        title: req.body.title,
        author: req.body.author,
        is_paperback: true
      });
    });
    ```

  * ğŸ”‘ Sequelize is Promise-based, so we add a `then()` and `catch()` to return the newly created book or an error message.

    ```js
    .then((newBook) => {
      res.json(newBook);
    })
    .catch((err) => {
      res.json(err);
    });
    ```

  * ğŸ”‘ We have a second POST route called `/seed` that uses the model's `bulkCreate()` method to insert multiple records in the database.

    ```js
    router.post('/seed', (req, res) => {
      Book.bulkCreate([
        {
          title: 'Make It Stick: The Science of Successful Learning',
          author: 'Peter Brown',
          isbn: '978-0674729018',
          pages: 336,
          edition: 1,
          is_paperback: false
        }
      ]);
    });
    ```

  * The `bulkCreate()` method could also be moved to a separate Node.js script to ensure it only happens once.

* Ask the class the following questions (â˜ï¸) and call on students for the answers (ğŸ™‹):

  * â˜ï¸ What Sequelize methods can we use to insert data into a database?

  * ğŸ™‹ `create()` and `bulkCreate()`

  * â˜ï¸ How can we test these methods as part of our Express.js routes?

  * ğŸ™‹ Make POST requests with Insomnia Core

* Answer any questions before proceeding to the next activity.

* In preparation for the activity, ask TAs to start directing students to the activity instructions found in `06-Stu_Create-Read/README.md`.

### 9. Student Do: Create Read (15 min) 

* Direct students to the activity instructions found in `06-Stu_Create-Read/README.md`.

* Break your students into pairs that will work together on this activity.

  ```md
  # ğŸ“ Add Comments to Implementation of Sequelize Query Methods

  Work with a partner to add comments describing the functionality of the code found in [Unsolved/routes/api/bookRoutes.js](./Unsolved/routes/api/bookRoutes.js).

  ## ğŸ“ Note(s)

  Refer to the documentation: 

  * [Sequelize docs on model querying](https://sequelize.org/master/manual/model-querying-basics.html)

  ---

  ## ğŸ† Bonus

  * If you have fully completed the above tasks, here is something you and your partner can work through as an added challenge to further your knowledge:

    * What is the difference between Sequelize's `create()` and `build()` methods?

  * Use [Google](https://www.google.com) or another search engine to research the above.
  ```

* While breaking everyone into groups, be sure to remind students and the rest of the instructional staff that questions on Slack or otherwise are welcome and will be handled. It's a good way for your team to prioritize students that need extra help while circulating through room.

### 10. BREAK (15 min)

### 11. Instructor Review: Create Read (10 min) 

* Ask the class the following questions (â˜ï¸) and call on students for the answers (ğŸ™‹):

  * â˜ï¸ How comfortable do you feel with Sequelize queries? (Poll via Fist to Five, Slack, or Zoom)

* Assure students that we will cover the solution to help solidify their understanding. If questions remain, remind them to use office hours to get extra help!

* Use the prompts and talking points below to review the following key (ğŸ”‘) points:

  * âœ”ï¸ `findAll()`

  * âœ”ï¸ `findByPk()`

  * âœ”ï¸ Query parameters

* Open `06-Stu_Create-Read/Solved/routes/api/bookRoutes.js` in your IDE and explain the following: 

  * ğŸ”‘ We use the `findAll()` method to get all books from the database and send them as JSON in the response.

    ```js
    router.get('/', (req, res) => {
      Book.findAll().then((bookData) => {
        res.json(bookData);
      });
    });
    ```

  * ğŸ”‘ We add optional parameters to the `findAll()` method to specify a sort order, filter results with a `WHERE` clause, and exclude certain attributes from the results.
  
    ```js
    router.get('/paperbacks', (req, res) => {
      Book.findAll({
        // Order by title in ascending order
        order: ['title'],
        where: {
          // Only get books that have this boolean set to TRUE
          is_paperback: true
        },
        attributes: {
          // Don't include these fields in the returned data
          exclude: ['is_paperback', 'edition']
        }
      }).then((bookData) => {
        res.json(bookData);
      });
    });
    ```

  * ğŸ”‘ We use the `findByPk()` method to get a single record based on its `book_id` primary key.

    ```js
      router.get('/:id', (req, res) => {
      Book.findByPk(req.params.id).then((bookData) => {
        res.json(bookData);
      });
    });
    ```

* Ask the class the following questions (â˜ï¸) and call on students for the answers (ğŸ™‹):

  * â˜ï¸ What is the plain SQL equivalent of `findAll()`?

  * ğŸ™‹ `SELECT * FROM book`

  * â˜ï¸ What is the plain SQL equivalent of `findByPk()`?

  * ğŸ™‹ `SELECT * FROM book WHERE book_id = x`

  * â˜ï¸ What can we do if we don't completely understand this?

  * ğŸ™‹ We can refer to supplemental material, read the [Sequelize docs on querying](https://sequelize.org/master/manual/model-querying-basics.html), and stick around for Office Hours to ask for help.

* Answer any questions before proceeding to the next activity.

### 12. Instructor Demo: Update, Delete (5 min) 

* Open `07-Ins_Update-Delete/routes/api/bookRoutes` in your IDE and demonstrate the following: 

  * ğŸ”‘ For the PUT route we specify the endpoint to match the `isbn` of a book inside of the database.

    ```js
      router.put('/:isbn', (req, res) => {
      // code...
      )};
    ```

  * ğŸ”‘ Inside the PUT route we call the `Book` model's `update()` method. The first parameters it takes are list of fields in the database and the coordinating data from the request body.

    ```js
    Book.update(
      {
        title: req.body.title,
        author: req.body.author,
        isbn: req.body.isbn,
        pages: req.body.pages,
        edition: req.body.edition,
        is_paperback: req.body.is_paperback,
      },
    ```

  * ğŸ”‘ The `update()` method takes a second parameter using the `WHERE` clause to specify which book should be updated. The `isbn` is being retrieved from the request parameters.

    ```js
    where: {
          isbn: req.params.isbn,
        },
    ```

   * ğŸ”‘ Sequelize is Promise-based, so we add `then()` and `catch()` to return the newly updated book or an error message.

      ```js
      .then((updatedBook) => {
        res.json(updatedBook);
      })
      .catch((err) => {
        res.json(err);
      });
      ```

  * ğŸ”‘ Rename the `.env.EXAMPLE` file and fill in your credentials. Run `npm start` from the `07-Ins_Update-Delete` directory. Open Insomnia Core and make a PUT request to `localhost:3001/api/books/:isbn` with following data in JSON format.

    ```json
    {
      "title": "Grokking Algorithms: An illustrated guide for programmers and other curious people",
      "author": "Aditya Bhargava",
      "edition": "1"
    },
    ```

  * ğŸ”‘ Run the GET route in Insomnia to show students the update.

  * ğŸ”‘ In the DELETE route we specify the `isbn` endpoint. Call the `Book` model's method `destroy` which accepts an object as one of its parameters. Use the `WHERE` clause inside the object to find the book that needs to be deleted based on the request parameters.
  
    ```js
    router.delete('/:isbn', (req, res) => {
      Book.destroy({
        where: {
        isbn: req.params.isbn,
      },
    })
      .then((deletedBook) => {
        res.json(deletedBook);
      })
      .catch((err) => res.json(err));
    });
    ```

  * ğŸ”‘ Open Insomnia Core and make a DELETE request to `localhost:3001/api/books/:isbn` with following data in JSON format.

    ```json
    {
      "isbn": "9780137043293"
    },
    ```

  ğŸ”‘ Run the GET route in Insomnia to show students the book 'Essential Scrum: A Practical Guide to the Most Popular Agile Process' was deleted

* Ask the class the following questions (â˜ï¸) and call on students for the answers (ğŸ™‹):

  * â˜ï¸ What is the plain SQL equivalent to `update()`?

  * ğŸ™‹  `UPDATE book SET title = x WHERE isbn = x`

  * â˜ï¸ Which method deletes in Sequelize?

  * ğŸ™‹  `destroy()`

  * â˜ï¸ What can we do if we don't completely understand this?

  * ğŸ™‹ We can refer to supplemental material, read the [Sequelize docs on querying](https://sequelize.org/master/manual/model-querying-basics.html), and stick around for Office Hours to ask for help.

* Answer any questions before proceeding to the next activity.

* In preparation for the activity, ask TAs to start directing students to the activity instructions found in `08-Stu_Update-Delete/README.md`.

### 13. Student Do: Update, Delete (15 min)

* Direct students to the activity instructions found in `08-Stu_Update-Delete/README.md`.

* Break your students into pairs that will work together on this activity.

```md
## ğŸ—ï¸ Implement the PUT and DELETE Route with Your Own Parameters

Work with a partner to implement the following user story:

* As a book store owner, I want to be able to update and remove certain books of my choice from our inventory.

## Acceptance Criteria

* It's done when a book can be updated based on specific parameters (e.g. 'numberOfPges').

* It's done when a book can be deleted based on specific parameters (e.g. 'bookid').

---

## ğŸ’¡ Hint(s)

* Which option do you need to use on the method call?

## ğŸ† Bonus

If you have fully completed the above tasks, here is something you and your partner can work through as an added challenge to further your knowledge:

  * What SQL operators does Sequelize support?

* Use [Google](https://www.google.com) or another search engine to research the above.

```

* While breaking everyone into groups, be sure to remind students and the rest of the instructional staff that questions on Slack or otherwise are welcome and will be handled. It's a good way for your team to prioritize students that need extra help while circulating through room.

### 14. Instructor Review: Update, Delete (10 min) 

* Ask the class the following questions (â˜ï¸) and call on students for the answers (ğŸ™‹):

  * â˜ï¸ How comfortable do you feel with the UPDATE and DELETE methods in Sequelize? (Poll via Fist to Five, Slack, or Zoom)

* Assure students that we will cover the solution to help solidify their understanding. If questions remain, remind them to use office hours to get extra help!

* Use the prompts and talking points below to review the following key (ğŸ”‘) points:

  * âœ”ï¸ `update()`

  * âœ”ï¸ `destroy()`

  * âœ”ï¸ `WHERE`

* Open `08-Stu_Update-Delete/Solved/routes/api/bookRoute.js` in your IDE and explain the following: 

  * ğŸ”‘ Use the `update()` method on the `Book` model mapping our request body to the proper fields in the database.

    ```js
    router.put('/:book_id', (req, res) => {
      Book.update(
      {
        title: req.body.title,
        author: req.body.author,
        isbn: req.body.isbn,
        pages: req.body.pages,
        edition: req.body.edition,
        is_paperback: req.body.is_paperback,
      },
    ```

  * ğŸ”‘ We add optional parameters to the `update()` method to specify which book we want to update with the `WHERE` clause. We use the request parameters to retrieve the `book_id` of the desired book.

    ```js
    where: {
      book_id: req.params.book_id,
    },
    ```

  * We then send our response with our updated book or catch any errors that may occur.

    ```js
    .then((updatedBook) => {
        res.json(updatedBook);
      })
      .catch((err) => {
        console.log(err);
        res.json(err);
      });
    ```

  * ğŸ”‘ Inside the DELETE route use the `destroy()` method on the `Book` model. We use the `WHERE` clause to filter the book we want to delete from the database.

    ```js
    router.delete('/:book_id', (req, res) => {

    Book.destroy({
      where: {
        book_id: req.params.book_id,
      },
    })
      .then((deletedBook) => {
        res.json(deletedBook);
      })
      .catch((err) => res.json(err));
    });
    ```

 * ğŸ”‘ Point out how express uses the `delete` keyword for DELETE routes but Sequelize uses the `destroy` keyword. This can be an easy mistake that can cause your route to not properly work.

* Ask the class the following questions (â˜ï¸) and call on students for the answers (ğŸ™‹):

  * â˜ï¸ What does the `WHERE` clause do?

  * ğŸ™‹ Helps us specify where in the database we want to look.

  * â˜ï¸ What can we do if we don't completely understand this?

  * ğŸ™‹ We can refer to supplemental material, read the [Sequelize docs on querying](https://sequelize.org/master/manual/model-querying-basics.html), and stick around for Office Hours to ask for help.

* Answer any questions before proceeding to the next activity.

### 15. Instructor Demo: Async / Await (5 min) 

* Open `09-Ins_Async-Await/routes/api/bookRoutes.js` in your browser and demonstrate the following:

  * ğŸ”‘ To make a function asynchronous we have to add the `async` keyword in front of our callback function. This tells JavaScript to return a promise instead of returning a value. 

    ```js
    router.get('/', async (req, res) => {
      // code...
    });
    ```

   * ğŸ”‘ Inside of the function's body we need to store the `Book` model's `findAll()` method inside of a variable named `bookData`. In front of the `Book` model you place the `await` keyword. The `await` keyword can only be placed inside of an `async` function. It tells JavaScript to wait untill the promise fullfills itself or throws an error. Lastly, we return the response with the `bookData`.

      ```js
      const bookData = await Book.findAll();

      return res.json(bookData);
      ```

   * ğŸ”‘ We call the `update()` method on the `Book` model with an objact mapping the request body to fields in the database. The `await` keyword does not prevent the code from running while it waits for the promise to fufill. It does the opposite, it allows other parts of the code to run but once the promise is fulfilled it will return its value.

      ```js
      router.put('/:book_id', async (req, res) => {
        const bookData = await Book.update(
          {
            title: req.body.title,
            author: req.body.author,
            isbn: req.body.isbn,
            pages: req.body.pages,
            edition: req.body.edition,
            is_paperback: req.body.is_paperback,
          },
          {
            where: {
              book_id: req.params.book_id,
            },
          }
        );

      return res.json(bookData);
      });
      ```

 * ğŸ”‘ This makes our asynchronous code read and run more like synchronous code. We have the added benefit of not having to deal with long `then()` and `catch()` chains.

* ğŸ”‘ Rename the `.env.EXAMPLE` file and fill in your credentials. Run `npm start` from the `09-Ins_Update-Delete` directory. Open Insomnia Core and show all request to `localhost:3001/api/books` still work.

* Ask the class the following questions (â˜ï¸) and call on students for the answers (ğŸ™‹):

  * â˜ï¸ What are some of the benefits of writing your code with `async / await`?

  * ğŸ™‹ The code is cleaner and easier to read. It uses fewer `.then()` chains. 

* Answer any questions before proceeding to the next activity.

* In preparation for the activity, ask TAs to start directing students to the activity instructions found in `10-Stu_Async-Await/README.md`.

### 16. Student Do: Async / Await (15 min) 

* Direct students to the activity instructions found in `10-Stu_Async-Await/README.md`.

* Break your students into pairs that will work together on this activity.

```md
# ğŸ—ï¸ Refactor the Code in bookSeeds.js  to use Async / Await Instead of Promises

Work with a partner to implement the following user story:

* As a developer, all my CRUD commands should still work when querying the database.

* As a developer, my code should be less cluttered with promises and instead use `async` / `await` for easier readability.

## Acceptance Criteria

* It's done when a book can still be created, updated, and deleted from the database.

* It's done when my `bookSeeds.js` no longer uses promises and utilizes `async` / `await`.

---

## ğŸ’¡ Hint(s)

* How does JavaScript know when a function is asynchronous?

## ğŸ† Bonus

If you have fully completed the above tasks, here is something you and your partner can work through as an added challenge to further your knowledge:

  * How could we run this seed file from an NPM script?

  *  How would you work with multiple models in an `index.js` file?

* Use [Google](https://www.google.com) or another search engine to research the above.

```

* While breaking everyone into groups, be sure to remind students and the rest of the instructional staff that questions on Slack or otherwise are welcome and will be handled. It's a good way for your team to prioritize students that need extra help while circulating through room.

### 17. Instructor Review: Async / Await (15 min)

* Ask the class the following questions (â˜ï¸) and call on students for the answers (ğŸ™‹):

  * â˜ï¸ How comfortable do you feel with `async` / `await`? (Poll via Fist to Five, Slack, or Zoom)

* Assure students that we will cover the solution to help solidify their understanding. If questions remain, remind them to use office hours to get extra help!

* Use the prompts and talking points below to review the following key (ğŸ”‘) points:

  * âœ”ï¸ `Async`

  * âœ”ï¸ `Await`

  * âœ”ï¸ Seeding with Sequelize

* Open `10-Stu_Async-Await/Solved/seeds/bookSeeds.js` in your IDE and explain the following: 

  * ğŸ”‘ This the proper way to seed a database with Sequelize versuses creating a `/seed` route like we did earlier.

  * We have to import our data from the JSON files inside the `seeds` folder to use inside our new asynchronous function.

    ```js
    const bookSeedData = require('./bookSeedData.json');
    const librarySeedData = require('./librarySeedData.json');
    ```

  * ğŸ”‘ We first need to add the `async` keyword to our `seedDatabase` function. This tells the function to return a promise.

    ```js
    const seedDatabase = async () => {

    };
    ```

   * ğŸ”‘ Since we are not running this function everytime our Express server starts we need to sync the database before we start to seed the database. We don't need to store it in a variable because we have no reason to return it.

      ```js
      const seedDatabase = async () => {

        await sequelize.sync({ force: true });

      };
      ```

   * ğŸ”‘ We take the `Book` and use the `bulkCreate()` method passing in the `bookSeedData` we imported. 

   * ğŸ”‘ We add the `await` keyword in front of the statement inside the `async` function body.

   * We repeat this process for the `librarySeedData` by adding the `await` keyword.

      ```js
      const seedDatabase = async () => {

        await sequelize.sync({ force: true });

        await Book.bulkCreate(bookSeedData);

        await Library.bulkCreate(librarySeedData);
  
      };
        ```

  * Once the promises have been fufilled and no errors have been thrown we want this function to stop running in Node. We do this with `process.exit(0)`

    ```js
    const seedDatabase = async () => {

      await sequelize.sync({ force: true });

      await Book.bulkCreate(bookSeedData);

      await Library.bulkCreate(librarySeedData);

      process.exit(0);
  
    };
    ```

  * ğŸ”‘ In the command line travel to this directory `10-Stu_Async-Await/Solved/seeds/bookSeeds.js` and run `npm start` to have this function trigger. This way the database does not get seeded everytime th Express server starts.

* Ask the class the following questions (â˜ï¸) and call on students for the answers (ğŸ™‹):

  * â˜ï¸ Where is it best to place your seed files?

  * ğŸ™‹ In a seperate folder named `seeds`, not on a route.

  * â˜ï¸ What does the `await` keyword tell JavaScript?

  * ğŸ™‹ The statement will either fufill a promise and return the value of that promise or throw an error.

  * â˜ï¸ How do we make a function asynchoronus?

  * ğŸ™‹ By placing the `async` keyword in front of the function.

  * â˜ï¸ What can we do if we don't completely understand this?

  * ğŸ™‹ We can refer to supplemental material, read the [MDN web docs on Async functions](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/async_function), and stick around for Office Hours to ask for help.

* Answer any questions before ending the class.

### 18. END (0 min)

How did todayâ€™s lesson go? Your feedback is important. Please take 5 minutes to complete [this anonymous survey](https://forms.gle/RfcVyXiMmZQut6aJ6).

---
Â© 2020 Trilogy Education Services, LLC, a 2U, Inc. brand.  Confidential and Proprietary.  All Rights Reserved.
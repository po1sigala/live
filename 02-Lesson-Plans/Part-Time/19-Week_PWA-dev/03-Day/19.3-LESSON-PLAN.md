# 19.3 Part-Time Lesson Plan: IndexedDB and PWAs

## Overview 

In today's class, students will have a chance to learn about a low-level API called IndexedDB which gives us the ability to store large amounts of data on the client-side. We have used `localstorage` in the past for client-side storage but we are very limited in how we store data and the type of data we can store using `localstorage`. IndexedDB can help us make more complex data structures and storage using just the client.

## Instructor Notes

* In this lesson, students will complete activities `21-Ins_IndexedDB` through `28-Stu_Mini-Project`.

* All of the activities besides the `28-Stu_Mini-Project` solely use a front-end. The `28-Stu_Mini-Project` requires a back end for us to successfully deploy the project to Heroku.

* We are dealing with client and web caching so make sure to clear your cookies regularly before each activity starts or take advantage of the [Incognito window from Google Chrome](https://support.google.com/chrome/answer/95464?hl=en&co=GENIE.Platform%3DDesktop#:~:text=You%20can%20also%20use%20a,Press%20%E2%8C%98%20%2B%20Shift%20%2B%20n.).

* For all of the activities, we will be using [Live Server](https://marketplace.visualstudio.com/items?itemName=ritwickdey.LiveServer) to open the `index.html` so make sure to have it installed.

* PWAs and IndexedDB can be frustrating at times so take some time to familiarize yourself with the behavior of each activity. This is also a good opportunity for students to practice troubleshooting unexpected behaviors in their application.

* Make it fun because after this unit students are starting on the Herculean task of learning React.

* Remind students to do a `git pull` of the class repo to have today's activities ready and open in VS Code. 

* If you are comfortable doing so, live-code the solutions to the activities. If not, just use the solutions provided and follow the prompts and talking points for review.

* Let students know that the Bonus at the end of each activity is not meant to be extra coding practice, but instead is a self-study on topics beyond the scope of this unit for those who want to further their knowledge.

* If the students struggle with the `Everyone Do: Git` activity, walk through it with the students using the talking points provided. Otherwise, support the students as they do the activity and do a brief review at the end. 

## Learning Objectives

By the end of class, students will be able to:

* Implement IndexedDB inside of a JavaScript application.

* Implement CREATE, READ, UPDATE, and DELETE commands for an IndexedDB instance.

* Convert an existing application into a Progressive Web Application (PWA).

* Deploy a Progressive Web Application to Heroku.

## Time Tracker
@TODO ADD ACTIVITY TITLES for Instructor Demo, Student Do, and Instructor Review
| Start  | #   | Activity Name                      | Duration |
|---     |---  |---                                 |---       |
| 10:00AM| 1   | Instructor Do: Stoke Curiosity     | 0:10     |
| 10:10AM| 2   | Instructor Demo: IndexedDB         | 0:05     |
| 10:15AM| 3   | Student Do: IndexedDB              | 0:15     |
| 10:30AM| 4   | Instructor Review: IndexedDB       | 0:10     |
| 10:40AM| 5   | Instructor Demo: IndexedDB CRUD    | 0:05     |
| 10:45AM| 6   | Student Do: IndexedDB CRUD         | 0:15     |
| 11:00AM| 7   | Instructor Review: IndexedDB CRUD  | 0:10     |
| 11:10AM| 8   | Instructor Demo: Manifest          | 0:05     |
| 11:15AM| 9   | Student Do: Manifest               | 0:15     |
| 11:30AM| 10  | Instructor Review: Manifest        | 0:10     |
| 11:40AM| 11  | Everyone Do: Git                   | 0:20     |
| 12:00PM| 12  | BREAK                              | 0:40     |
| 12:40PM| 13  | Instructor Demo: Mini-project      | 0:05     |
| 12:45PM| 14  | Student Do: Mini-project           | 0:60     |
| 1:45PM | 15  | Instructor Review: Mini-project    | 0:10     |
| 1:55PM | 16  | Introduce Homework                 | 0:05     |
| 2:00PM | 17  | END                                | 0:00     |

> **Important**: If this lesson occurs on a weekday, you'll follow a different schedule to accommodate for the shorter class time. The `Stoke Curiosity` section is shortened by 5 minutes, the break by 25 minutes, and the `Student Do: Mini-project` by 10 minutes, and the `Everyone Do: Git` activity is omitted completely.

<details>
  <summary>Click to show the adjusted time tracker</summary>

| Start  | #   | Activity Name                       | Duration |
|---     |---  |---                                  |---       |
| 6:30PM | 1   | Instructor Do: Stoke Curiosity      | **0:05** | 
| 6:35PM | 2   | Instructor Demo: IndexedDB          | 0:05     |
| 6:40PM | 3   | Student Do: IndexedDB               | 0:15     |
| 6:55PM | 4   | Instructor Review: IndexedDB        | 0:10     |
| 7:05PM | 5   | Instructor Demo: IndexedDB CRUD     | 0:05     |
| 7:10PM | 6   | Student Do: IndexedDB CRUD          | 0:15     |
| 7:25PM | 7   | Instructor Review: IndexedDB CRUD   | 0:10     |
| 7:35PM | 8   | Instructor Demo: Manifest           | 0:05     |
| 7:40PM | 9   | Student Do: Manifest                | 0:15     |
| 7:55PM | 10  | BREAK                               | **0:15** |
| 8:10PM | 11  | Instructor Review: Manifest         | 0:10     |
| 8:20PM | 12  | Instructor Demo: Mini-project       | 0:05     |
| 8:25PM | 13  | Student Do: Mini-project            | **0:50** |
| 9:15PM | 14  | Instructor Review: Mini-project     | 0:10     |
| 9:25PM | 15  | Introduce Homework                  | 0:05     |
| 9:30PM | 16  | END                                 | 0:00     |
</details>

---

## Class Instruction

### 1. Instructor Do: Stoke Curiosity (10 min)

* Welcome students to class.

* Congratulate the class on learning how to implement new web technologies like webpack and workbox. These tools can give our application a better performance boost so more users can access our application.

* Remind students that the React unit is on the horizon and much of what they learned in this unit can be applied in React.

* Today's class will be focused on making our application installable on users' devices!

* The web applications we create can be configured to act like a native application.

* Ask the class the following questions (‚òùÔ∏è) and call on students for the answers (üôã):

  * ‚òùÔ∏è What are some examples of native applications?

  * üôã Microsoft Word, Zoom, basically any application that you need to install.

  * ‚òùÔ∏è What are some benefits of native application?

  * üôã Doesn't always require an internet connection and desktop icon!

* We also will be taking a look at a new API called IndexedDB which will unlock a more advanced front-end data storage option.

* Ask the class the following questions (‚òùÔ∏è) and call on students for the answers (üôã):

  * ‚òùÔ∏è How have we stored data on the front end in the past?

  * üôã Local Storage!

* We will be able to run CRUD operations and process data much more efficiently with IndexedDB versus local storage.

* Answer any questions before proceeding to the next activity.

### 2. Instructor Demo: IndexedDB (5 min) 

* Open `21-Ins_IndexedDB/assets/js/database.js` in your IDE and explain the following:

  * üîë We have to install the `idb` package and import it into the `database.js` file, as shown below:

  ```js
  import { openDB } from 'idb';
  ```

  * The `idb` package is a lightweight wrapper that takes care of some of the more messy parts of IndexedDB. The main reason we are using the `idb` package is it allows us to take advantage of Async / Await.

  * We have created an asynchronous function called `initDB()` which will immediately the `OpenDB` method we imported earlier, as shown in the following:

  ```js
  const initdb = async () =>
    openDB('demo-db', 1, {
    
  });
  ```

  * üîë The first argument is the name of the database we want to which is `demo-db`, followed by that we have the version number.

  * The version number allows us to check if our user is using an old version of our schema. This will be our only schema so we will not have to worry about changing versions.

  * üîë Next, we set the correct schema using the `upgrade` method, as shown in the following:

   ```js
    const initdb = async () =>
      openDB('demo-db', 1, {
        upgrade(db) {
        if (db.objectStoreNames.contains('demo-db')) {
          console.log('demo-db database already exists');
          return;
        }

        db.createObjectStore('demo-db', { keyPath: 'id', autoIncrement: true });
        console.log('demo-db database created');
      },
  });
  ```

  * üîë Check to see if the user already has the `demo-db` object. If not, create a new one called `demo-db` with the `creaateObjectStore()` method.

  * üîë We use the `keyPath` property to specify the name of the key field in the `demo-db` object and set it to auto-increment.

  * Finally, we call the `initDb()` function at the bottom of the `database.js` file, as shown in the following:

  ```js
  initDb()
  ```

* Run `npm run start` travel to the `Application` tab in Chrome Dev Tools and demonstrate the following: 

  * üîë In the `Cache Storage` section, if we expand it we can see the `demo-db` storage object.

  * üîë By clicking on the storage object, we can already see the id field even though we have zero records.

* Ask the class the following questions (‚òùÔ∏è) and call on students for the answers (üôã):

  * ‚òùÔ∏è How would we build this?

  * üôã By using the `OpenDB()` from the `idb` package.

* Answer any questions before proceeding to the next activity.

* In preparation for the activity, ask TAs to start directing students to the activity instructions found in `22-Stu_IndexedDB/README.md`.

### 3. Student Do: IndexedDB (15 min) 

* Direct students to the activity instructions found in `22-Stu_IndexedDB/README.md`.

* Break your students into pairs that will work together on this activity.

  ```md
  # üìê Add Comments to Implementation of IndexedDB

  Work with a partner to add comments describing the functionality of the code found in the [database.js](./Unsolved/src/js/database.js) file.

  ## üìù Notes

  To launch the application, follow these steps:

  1. In the command line, navigate to `24-Stu_IndexedDB/Unsolved`.

  2. Run `npm install`.

  3. To launch the application, run `npm run start`.

  4. Open the `index.html` file in the `dist` directory.

  5. To view the IndexedDB store, visit the `Application` tab in Chrome DevTools.


  Refer to the documentation: 

  * [idb NPM Page](https://www.npmjs.com/package/idb)

  * [MDN Web Docs on the IndexedDB API](https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API)

  ---

  ## üèÜ Bonus

  If you have completed this activity, work through the following challenge with your partner to further your knowledge:

  * How does an object store in IndexedDB compare to a table or collection in other databases?

  Use [Google](https://www.google.com) or another search engine to research this.
  ```

* While breaking everyone into groups, be sure to remind students and the rest of the instructional staff that questions on Slack or otherwise are welcome and will be handled. It's a good way for your team to prioritize students who need extra help.

### 4. Instructor Review: IndexedDB (10 min)  

* Ask the class the following questions (‚òùÔ∏è) and call on students for the answers (üôã):

  * ‚òùÔ∏è How comfortable do you feel with IndexedDB? (Poll via Fist to Five, Slack, or Zoom)

* Assure students that we will cover the solution to help solidify their understanding. If questions remain, remind them to use office hours to get extra help!

* Use the prompts and talking points (üîë) below to review the following key points:

  * ‚úîÔ∏è Set up IndexedDB

  * ‚úîÔ∏è Create an object store

  * ‚úîÔ∏è Versions

* Open `22-Stu_IndexedDB/Solved/assets/js/database.js` in your IDE and explain the following: 

  * We import in the `idb` package and create an asynchronous  `initDB()` function, as shown in the following:

    ```js
    import { openDB } from 'idb';

    const initdb = async () =>
    ```

  * üîë The `idb` package allows us to make IndexedDB asynchronous and cleans up a lot of the messy syntax that IndexedDB has.

  * We call the `OpenDB()` method from the `idb` package, as shown in the following:

  ```js
  const initdb = async () =>
  openDB('todos', 1, {
    upgrade(db) {
      if (db.objectStoreNames.contains('todos')) {
        console.log('todos database already exists');
        return;
      }

      db.createObjectStore('todos', { keyPath: 'id', autoIncrement: true });
      console.log('todos database created');
    },
  });
  ```

  * üîë For the `OpenDB()` method we pass in the name of our database and the version we want to use.

  * üîë Next, we call the `upgrade()` function which takes our database as an argument. Check to see if the object store already exists in the users' web browser.

  * üîë Finally, we create a new object store if one doesn't already exist. The object store will always have an `id` `keyPath` that auto increments for us.

* Ask the class the following questions (‚òùÔ∏è) and call on students for the answers (üôã):

  * ‚òùÔ∏è What does the `keyPath` do?

  * üôã It automatically creates a new key to identify data records that are stored in the database.

  * ‚òùÔ∏è Which tab in Chrome Dev Tools can we inspect our object store?

  * üôã The `Application` tab under Cache Storage.

  * ‚òùÔ∏è What can we do if we don't completely understand this?

  * üôã We can refer to supplemental material, read the [MDN Web Docs on IndexedDB](https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API), and stick around for office hours to ask for help.

* Answer any questions before proceeding to the next activity.

### 5. Instructor Demo: IndexedDB CRUD (5 min) 

* Open `23-Stu_IndexedDB-CRUD/assets/js/database.js` in your IDE and explain the following:

  * üîë To use the IndexedDB object store we set up, we need to implement CRUD operation.

  * We create and export an asynchronous function called `postDb()`, as shown below:

  ```js
  export const postDb = async (content) => {
    
  };
  ```

  * The function above will accept the `content` that we want to store in the database as an argument. 

  * Next, we open up a transaction with our database, as shown below:

  ```js
  export const postDb = async (content) => {
    const todosDb = await openDB('todos', 1);

    const tx = todosDb.transaction('todos', 'readwrite');

    const store = tx.objectStore('todos');

    const request = store.add({ todo: content });

    const result = await request;
    console.log('üöÄ - data saved to the database', result);
  };
  ```

  * üîë Store the connection to our database inside of a variable calledOnce `todosDb`.

  * üîë Next, create a new `transaction` that expects the database name and privileges. Since we are writing to the database, we need to set the privileges to `readwrite`.

  * üîë Create a variable that will hold a reference to the object-store. 

  * üîë Finally, we use the `add()` method that is attached to the object store and pass in the `contents`.

  * Once we have finished writing to the database, we expect a result to confirm the transaction.

  * Let's look at how we can retrieve all the data in the database, as shown in the following:

  ```js
  // Export a function we will use to GET all from the database.
  export const getAllDb = async () => {
    // Create a connection to the database database and version we want to use.
    const todosDb = await openDB('todos', 1);

    // Create a new transaction and specify the database and data privileges.
    const tx = todosDb.transaction('todos', 'readonly');

    // Open up the desired object store.
    const store = tx.objectStore('todos');

    // Use the .getAll() method to get all data in the database.
    const request = store.getAll();

    // Get confirmation of the request.
    const result = await request;
    console.log('result.value', result);
    return result;
  };
  ```

  * üîë Very similar to earlier, but this time we are using `getAll()` on the object-store.

  * Let's look at how we can retrieve a single record in the database, as shown in the following:

  ```js
  export const getOneDb = async (id) => {
    console.log('GET from the database');

    // Create a connection to the database and version we want to use.
    const todosDb = await openDB('todos', 1);

    // Create a new transaction and specify the database and data privileges.
    const tx = todosDb.transaction('todos', 'readonly');

    // Open up the desired object store.
    const store = tx.objectStore('todos');

    // Use the .get() method to get a piece of data from the database based on the id.
    const request = store.get(id);

    // Get confirmation of the request.
    const result = await request;
    console.log('result.value', result);
    return result;
  };
  ```

  * üîë Similar to earlier, but this time we are using `get()` on the object store and pass in the `id`.

* Run `npm run dev` and open up the `localhost:8080` then demonstrate the following: 

  * Add an item to the TODO list and open the `Application` tab in Chrome Dev Tools. Under the `Cache Storage` section and inspect the contents of the object-store.

  * üîë We see that our data is now being stored and retrieved from the IndexedDB object-store.

* Ask the class the following questions (‚òùÔ∏è) and call on students for the answers (üôã):

  * ‚òùÔ∏è How would we build this?

  * üôã We need to open up a transaction with the desired object store and use to correct method on our store.

* Answer any questions before proceeding to the next activity.

* In preparation for the activity, ask TAs to start directing students to the activity instructions found in `24-Stu_IndexedDB-CRUD/README.md`.

### 6. Student Do: IndexedDB CRUD (15 min) 

* Direct students to the activity instructions found in `24-Stu_IndexedDB-CRUD/README.md`.

* Break your students into pairs that will work together on this activity.

  ```md
  # üêõ The Delete Button Does Not Remove The Card When Clicked

  Work with a partner to resolve the following issue(s):

  * As a user, I want to be able to delete on click, and edit a list item when I click on the list item.

  ## Expected Behavior

  When a user clicks the delete button, the contact card will be removed from the page.

  ## Actual Behavior

  When a user clicks the delete button, the To-Do list item remains on the page and an error is thrown in the console.

  ## Steps to Reproduce the Problem

  1. In the command line, navigate to `24-Stu_IndexedDB-CRUD/Unsolved`.

  2. Run `npm install`.

  3. To launch the application, run `npm run dev`.

  4. Navigate to `http://localhost:8080` in your browser.

  5. Create a new To-Do item at the bottom of the page.

  6. Click on a list item which should remove the list item.

  7. Click on the edit button and we should be able to edit the list item.

  ## Assets

  The following image demonstrates the web application's appearance and functionality:

  ![Demo of the TODO list by adding, removing, and editing a list item](./Assets/todo-list.gif)

  ---

  ## üí° Hints

  What types of permissions do you need when altering data inside of a database? 

  ## üèÜ Bonus

  If you have completed this activity, work through the following challenge with your partner to further your knowledge:

  * How does the usage of CRUD operations with IndexedDB compare with their usage with SQL databases? 

  Use [Google](https://www.google.com) or another search engine to research this.
  ```

* While breaking everyone into groups, be sure to remind students and the rest of the instructional staff that questions on Slack or otherwise are welcome and will be handled. It's a good way for your team to prioritize students who need extra help.

### 7. Instructor Review: IndexedDB CRUD (10 min)  

* Ask the class the following questions (‚òùÔ∏è) and call on students for the answers (üôã):

  * ‚òùÔ∏è How comfortable do you feel with CRUD in IndexedDB? (Poll via Fist to Five, Slack, or Zoom)

* Assure students that we will cover the solution to help solidify their understanding. If questions remain, remind them to use office hours to get extra help!

* Use the prompts and talking points (üîë) below to review the following key points:

  * ‚úîÔ∏è IndexedDB CRUD

  * ‚úîÔ∏è `.delete()`

  * ‚úîÔ∏è `.put()`

* Open `24-Stu_IndexedDB-CRUD/Solved/assets/js/database.js` in your IDE and explain the following: 

  * üîë Since we are altering a record in the database, we need to use `readwrite` privileges in our transaction.

    ```js
    export const deleteDb = async (id) => {
      console.log('DELETE from the database', id);
      const todosDb = await openDB('todos', 1);
      const tx = todosDb.transaction('todos', 'readwrite');
      const store = tx.objectStore('todos');
      const request = store.delete(id);
      const result = await request;
      console.log('result.value', result);
      return result;
    };
    ```

  * üîë We must use the `todos` database in the transaction for the proper data to be updated.

  ```js
  export const putDb = async (id, content) => {
    console.log('PUT to the database');
    const todosDb = await openDB('todos', 1);
    const tx = todosDb.transaction('todos', 'readwrite');
    const store = tx.objectStore('todos');
    const request = store.put({ id: id, todo: content });
    const result = await request;
    console.log('üöÄ - data saved to the database', result);
  };
  ```

* Ask the class the following questions (‚òùÔ∏è) and call on students for the answers (üôã):

  * ‚òùÔ∏è What is the name of the method to get all of the records in the database?

  * üôã `getAll()`

  * ‚òùÔ∏è What can we do if we don't completely understand this?

 * üôã We can refer to supplemental material, read the [MDN Web Docs on IndexedDB](https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API), and stick around for office hours to ask for help.

* Answer any questions before proceeding to the next activity.

### 8. Instructor Demo: Manifest (5 min) 

* Open `25-Ins_Manifest/manifest.json` in your IDE and explain the following:

  * üîë The `manifest.json` file is a JSON file that contains certain metadata about our web application that informs the user's browser or mobile device how to run the application.

  * üîë For our web application, we have to provide a `name` property inside the `manifest.json` file, such as the following:

  ```json
  {
    "short_name": "Manifest",
    "name": "TODOs Manifest Example",
  }
  ```

  * We can optionally provide a `short_name` for our web application.

  * üîë Next, we provide our `icons` for all different types of screens, as shown below:

  ```json
  {
    "short_name": "Manifest",
    "name": "TODOs Manifest Example",
    "icons": [
      {
        "src": "/assets/images/icon_96x96.png",
        "type": "image/png",
        "sizes": "96x96",
        "purpose": "any maskable"
      },
      {
        "src": "/assets/images/icon_128x128.png",
        "type": "image/png",
        "sizes": "128x128",
        "purpose": "any maskable"
      },
      {
        "src": "/assets/images/icon_192x192.png",
        "type": "image/png",
        "sizes": "192x192",
        "purpose": "any maskable"
      },
      {
        "src": "/assets/images/icon_512x512.png",
        "type": "image/png",
        "sizes": "512x512",
        "purpose": "any maskable"
      }
    ],
  }
  ```

  * üîë We have to provide an image that is `512px` large so that our `manifest.json` file can create a loading screen for our application.

  * Let's finish up with the `manifest.json` file by adding a `description` and a few other properties, such as:

  ```json
  {
  "short_name": "Manifest",
  "name": "TODOs Manifest Example",
  "icons": [
    {
      "src": "/assets/images/icon_96x96.png",
      "type": "image/png",
      "sizes": "96x96",
      "purpose": "any maskable"
    },
    {
      "src": "/assets/images/icon_128x128.png",
      "type": "image/png",
      "sizes": "128x128",
      "purpose": "any maskable"
    },
    {
      "src": "/assets/images/icon_192x192.png",
      "type": "image/png",
      "sizes": "192x192",
      "purpose": "any maskable"
    },
    {
      "src": "/assets/images/icon_512x512.png",
      "type": "image/png",
      "sizes": "512x512",
      "purpose": "any maskable"
    }
  ],
  "orientation": "portrait",
  "display": "standalone",
  "start_url": "/",
  "description": "Keep track of important tasks!",
  "background_color": "#7eb4e2",
  "theme_color": "#7eb4e2"
  }
  ```

  * üîë Here we provide a `start_url` for our web application and some styling with the `theme_color` and `background_color`.

* Open `25-Ins_Manifest/assets/js/install.js` in your IDE and explain the following:

  * üîë When we launch the application in our browser, we will see an install button inside of the address bar.

  * üîë We also can create our own install button, using the following:

  ```js
  const installBtn = document.getElementById("installBtn");

  window.addEventListener('beforeinstallprompt', (event) => {
      console.log('üëç', 'beforeinstallprompt', event);
      // Store the event so it can be used later.
      window.deferredPrompt = event;
      // Remove the 'hidden' class from the install anchor tag.
      installBtn.classList.toggle('hidden', false);
    });

  installBtn.addEventListener('click', async () => {
    console.log('üëç', 'installBtn-clicked');
    const promptEvent = window.deferredPrompt;
    if (!promptEvent) {
    return;
    }
    // Show the install prompt.
    promptEvent.prompt();
    // Show the result
    const result = await promptEvent.userChoice;
    console.log('üëç', 'userChoice', result);
    // Reset the deferred prompt variable, prompt() can only be used once.
    window.deferredPrompt = null;
    installBtn.classList.toggle('hidden', true);
  });

  window.addEventListener('appinstalled', (event) => {
    console.log('üëç', 'appinstalled', event);
    // Clear the prompt
    window.deferredPrompt = null;
  });
  ```

  * We have connected our `<a>` tag to now launch the installation prompt.

* Open `25-Ins_Manifest/service-worker.js` in your IDE and explain the following:

  * üîë For the `manifest.json` file to work, you need a service worker in place. Here we have just created a simple service worker that caches the assets.

* Open `25-Ins_Manifest/index.html` in your IDE and explain the following:

  * üîë For the `manifest.json` file to work, you need to import it into our `index.html` file, like in the following:

  ```html
  <link rel="manifest" href="./manifest.json">
  ```

* Open `25-Ins_Manifest/index.html` with Live Server and demonstrate the following: 

  * Click the install button in the address bar.

  * Click the `Install!` button on the web page.

* Ask the class the following questions (‚òùÔ∏è) and call on students for the answers (üôã):

  * ‚òùÔ∏è How would we build this?

  * üôã With a `manifest.json` file!

* Answer any questions before proceeding to the next activity.

* In preparation for the activity, ask TAs to start directing students to the activity instructions found in `26-Stu_Manifest/README.md`.

### 9. Student Do: Manifest (15 min) 

* Direct students to the activity instructions found in `26-Stu_Manifest/README.md`.

* Break your students into pairs that will work together on this activity.

  ```md
  # üìñ Implement a Manifest.json file with Webpack

  Work with a partner to implement the following user story:

  * As a developer, I want to be able to automatically generate a `manifest.json` file inside my `dist` when I run my application.

  ## Acceptance Criteria

  * It's done when I can install my application as a Progressive Web App.

  * It's done when I can see my `manifest.json` file generated inside of Chrome Dev Tools.

  ## üìù Notes

  Refer to the documentation:

  [Webpack PWA Manifest plugin documentation.](https://www.npmjs.com/package/webpack-pwa-manifest)

  ---

  ## üí° Hints

  How could our JSON be represented in a JavaScript object? 

  ## üèÜ Bonus

  If you have completed this activity, work through the following challenge with your partner to further your knowledge:

  * What are each of the keys in a `manifest.json` file responsible for? 

  Use [Google](https://www.google.com) or another search engine to research this.
  ```

* While breaking everyone into groups, be sure to remind students and the rest of the instructional staff that questions on Slack or otherwise are welcome and will be handled. It's a good way for your team to prioritize students who need extra help.

### 10. Instructor Review: Manifest (10 min)  

* Ask the class the following questions (‚òùÔ∏è) and call on students for the answers (üôã):

  * ‚òùÔ∏è How comfortable do you feel with `manifest.json`? (Poll via Fist to Five, Slack, or Zoom)

* Assure students that we will cover the solution to help solidify their understanding. If questions remain, remind them to use office hours to get extra help!

* Use the prompts and talking points (üîë) below to review the following key points:

  * ‚úîÔ∏è `manifest.json`

  * ‚úîÔ∏è Installable Web Application

  * ‚úîÔ∏è `manifest.json` properties

* Open `26-Stu_Manifest/Solved/webpack.config.js` in your IDE and explain the following: 

  * üîë Install the webpack plugin `webpack-pwa-manifest`, shown below:

  ```bash
  npm install --save-dev webpack-pwa-manifest
  ```

  * Import the `webpack-pwa-manifest` package into your `webpack.config.js` file, as shown in the following:

  ```js
  const WebpackPwaManifest = require('webpack-pwa-manifest');
  ```

  * üîë Under the `plugins` property, declare a new plugin using `WebpackPwaManifest`, like in the following:

  ```js
  plugins: [
      new HtmlWebpackPlugin({
        template: './index.html',
      }),

      new GenerateSW(),
      new WebpackPwaManifest({ }),
     
    ],
  ```

  * üîë Fill out the JavaScript object with the properties we saw inside the `manifest.json` file earlier, as shown in the following:

  ```js
  plugins: [
      new HtmlWebpackPlugin({
        template: './index.html',
      }),

      new GenerateSW(),
      new WebpackPwaManifest({
        name: 'TODOs',
        short_name: 'TODOs',
        description: 'Keep track of important tasks!',
        background_color: '#7eb4e2',
        theme_color: '#7eb4e2',
        start_url: '/',
        publicPath: '/',
        icons: [
          {
            src: path.resolve('assets/images/logo.png'),
            sizes: [96, 128, 192, 256, 384, 512],
            destination: path.join('assets', 'icons'),
          },
        ],
       }),
     
    ],
  ```

* üîë You can see most of the JSON coordinates to a key in the JavaScript object, but we have two properties that look different.

* üîë The `publicPath` tells webpack where to serve the bundled.

* üîë The `icons` now generate the properly sized icons for us based on one provided image.

* Ask the class the following questions (‚òùÔ∏è) and call on students for the answers (üôã):

  * ‚òùÔ∏è What is the name of the webpack plugin that we use to generate a `manifest.json` file?

  * üôã `webpack-pwa-manifest`!

   * ‚òùÔ∏è Do we need a service worker for us to use a `manifest.json` file?

  * üôã Yes!

  * ‚òùÔ∏è What can we do if we don't completely understand this?

  * üôã We can refer to supplemental material, read the [MDN Web Docs on manifest.json](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json), and stick around for office hours to ask for help.

* Answer any questions before proceeding to the next activity.

* In preparation for the activity, ask TAs to start directing students to the activity instructions found in `27-Evr_Git-Hooks/README.md`.

### 11. Everyone Do: Git (20 min)

* Open the [Git Docs on Git Hooks](https://git-scm.com/book/en/v2/Customizing-Git-Git-Hooks) in your browser and explain the following:

  * When working with a team, we often have a certain set of practices that we want everyone to follow when using a repository. Git hooks provide a convenient way to execute custom scripts when a certain action is performed to remind the team of the established rules.

  * For example, if we want to add a reminder to our teammates about the way the commit message should be styled, we can set up a Git hook to listen for a commit event and then execute a script to send an automated reminder.

  * Each Git hook is local to a single repository and we must install the hook in each repository where we want the script to execute.

  * To install a Git hook, we either start with a pre-written sample hook provided by Git or write a custom hook on our own.

* Direct students to the activity instructions found in `27-Evr_Git-Hooks/README.md`.

* While everyone is working on the activity, be sure to remind students and the rest of the instructional staff that questions on Slack or otherwise are welcome and will be addressed. It's a good way for your team to prioritize students who need extra help.

* Open your command line and demonstrate the following:

  * üîë We initialize a new repository and enter `ls .git/hooks` to see a list of pre-written sample hooks that Git provides with each new repository:

    ```bash
    mkdir hook-test
    cd hook-test
    git init
    ls .git/hooks
    ```

  * Let's explore one of these hooks. We enter `code .git/hooks/pre-commit.sample` to open the `pre-commit` hook in VS Code.

  * üîë We see that Git hooks are written as shell hooks, and this hook is executed before a commit is made to check if files that use non-ASCII names are being used. To apply this hook to our repository, we simply rename it and remove the `.sample` extension:
  
    ```bash
    mv .git/hooks/pre-commit.sample .git/hooks/pre-commit
    ```

  * üîë We can also write our own custom hooks. To start, we add a new file in the `hooks` directory to hold our custom hook and set the permissions to execute:

    ```bash
    touch .git/hooks/post-checkout
    chmod +x .git/hooks/post-checkout
    code .git/hooks/post-checkout
    ```

  * We then add the shell script logic to set a safe list of issue/feature names, get the current branch, and check if the name matches a name in the safe list:

  ```bash
  #!/bin/sh
  safelist=("main", "develop", "staging")
  branch=$(git branch --show-current)
  if [[ ! ${safelist[*]} =~ "$branch" ]] && [[ ! "$branch" =~ ^(issue/|feature/).* ]]
  then
    echo "Warning!"
    echo 'If feature or issue branch, please use "issue/" or "feature/" prefix.'
  fi
  ```

 * We can now use our new Git hook to set a reminder to use the team's naming convention within the repository.  

* Answer any questions before students go on break.

### 12. BREAK (40 min)

### 13. Instructor Demo: Mini Project (5 min) 

* Navigate to `28-Stu_Mini-Project/Main` from the command line and run `npm install` and `npm run start`.

* Open <http://localhost:3001/> in your browser and demonstrate the following:

  * The homepage is a simple form with contact information.

  * When we fill out the form and submit it, we create a new contact card.

* Open the `Application` tab in your Chrome DevTools and demonstrate the following:

  * üîë We see that the cards are being saved and retrieved by the `contact` object store under the `Cache Storage` section.

  * üîë We can also see that we have a manifest file and active service worker caching assets.

  * We can also install our application via the button in the header or address bar.

* Open the `Elements` tab in your Chrome DevTools, expand the `<head>` element and demonstrate the following:

  * üîë We see that our files are being bundled with webpack.

* Ask the class the following questions (‚òùÔ∏è) and call on students for the answers (üôã):

  * ‚òùÔ∏è How would we build this?

  * üôã With webpack, workbox, and IndexedDB!

* Answer any questions before allowing students to start the mini-project.

### 14. Student Do: Mini Project (60 min)

* Direct students to the activity instructions found in `28-Stu_Mini-Project/README.md`.

* Break your students into groups that will work together on this activity.

  ```md
  # Unit 19 Mini-Project: Deploy Contact Directory App on Heroku with Script

  In this mini-project, you are given a simple application that needs to be updated to use Webpack, service-workers, IndexedDB, and we need it to have PWA functionality to work properly. Once we have updated our application with these new features, we can work on Deploying our application to Heroku. Heroku isn't new to us, but we will need to work on a handful of special scripts so Heroku knows to deploy our bundled application.

  ## User Stories

  Work with your group to resolve the following issues:

  * As a user, I want to be able to install the web application as a PWA.

  * As a user, I want to be able to add and remove my contact cards.

  * As a developer, I want all my scripts to run from the root directory `package.json`.

  * As a developer, I want to be able to run in the command line `npm run start` and have both my client and server start.

  * As a developer, I want to be able to run in the command line `npm run start:prod` to run our build script and start our server. 

  * As a developer, I want to be able to run in the command line `npm run server` and have just our server start without the client.

  * As a developer, I want to be able to run in the command line `npm run build` and have our client run the Webpack build script.

  * As a developer, I want to be able to run in the command line `npm run install` and have all of the client's dependencies installed.

  * As a developer, I want to be able to run in the command line `npm run client` and have just our client start without the server.

  ## Acceptance Criteria

  The mini-project is complete when the following criteria are met:

  * The application uses Webpack for bundling.

  * The application uses a service worker to cache static assets.

  * The application uses IndexedDB GET, ADD, and DELETE methods.

  * The application uses babel for async/await.

  * The application uses CSS loaders.

  * Scripts are placed in the root and client directory's `package.json`.

  * `npm run start` starts both the client and server.

  * `npm run start:prod` runs the `build` script and starts the server.

  * `npm run server` starts just the server and not the client.

  * `npm run build` runs the webpack build script in the client.

  * `npm run install` installs the dependencies for the client.

  * `npm run client` starts the client without the server.

  * The web application can be installed from the web address provided by Heroku.

  * Deployed using Heroku.

  ---

  ## üí° Hints

  * How do you navigate to different directories inside of bash?

  * What is the operator for "and"?

  ## üèÜ Bonus

  If you have completed this activity, work through the following challenge with your partner to further your knowledge:

  * Incorporate a way to edit information on the contact card using a PUT method with IndexedDB.
  ```

* While breaking everyone into groups, be sure to remind students and the rest of the instructional staff that questions on Slack or otherwise are welcome and will be handled. It's a good way for your team to prioritize students who need extra help.

### 15. Instructor Review: Mini Project  (10 min)  

* Ask the class the following questions (‚òùÔ∏è) and call on students for the answers (üôã):

  * ‚òùÔ∏è How comfortable do you feel with this mini-project? (Poll via Fist to Five, Slack, or Zoom)

* Assure students that we will cover the solution to help solidify their understanding. If questions remain, remind them to use office hours to get extra help!

* Use the prompts and talking points (üîë) below to review the following key points:

  * ‚úîÔ∏è Deploy to Heroku

  * ‚úîÔ∏è Build Scripts

  * ‚úîÔ∏è IndexedDB

* Open `28-Stu_Mini-Project/Main/package.json` in your IDE and explain the following: 

  * We need to create a few basic scripts to get the application running, as shown in the following:

    ```json
     "scripts": {
        "server": "cd server nodemon server.js --ignore client",
        "build": "cd client && npm run build",
        "install": "cd client && npm install",
        "client": "cd client && npm start"
    },
    ```

  * üîë `server` will start up only the server-side of our application.

  * üîë `build` will change directories into the `client` and run the clients build script which we will look at shortly.

  * üîë `Install` will change directories into the `client` and install all the necessary packages.

  * üîë `client` will just start the client.

  * üîë We now have to install the `concurrently` package for our next script, as shown in the following:

    ```json
     "scripts": {
        "start:dev": "concurrently \"cd server && npm run server\" \"cd client && npm run dev\"",
        "start": "npm run build && cd server && node server.js",
        "server": "cd server nodemon server.js --ignore client",
        "build": "cd client && npm run build",
        "install": "cd client && npm install",
        "client": "cd client && npm start"
    },
    ```

  * üîë `start:dev` will run our server and webpack server at the same time.

  * üîë `start` will run our server and webpack build the client for us.

* Open `28-Stu_Mini-Project/Main/client/package.json` in your IDE and explain the following:

  * For the root level `package.json` scripts to work, we need to set up the webpack scripts in the client `package.json` file, as shown below:

  ```json
  "scripts": {
    "dev": "webpack-dev-server",
    "build": "webpack --mode production",
    "start": "webpack --watch"
  },
  ```

  * üîë Now the root level `package.json` can communicate with the client `package.json`.

* Open `28-Stu_Mini-Project/Main/client/src-sw.js` in your IDE and explain the following:

  * Now we create a simple service worker with a workbox to cache static assets for us, as shown in the following:

  ```js
  const { StaleWhileRevalidate } = require('workbox-strategies');
  const { registerRoute } = require('workbox-routing');
  const { CacheableResponsePlugin } = require('workbox-cacheable-response');
  const { precacheAndRoute } = require('workbox-precaching/precacheAndRoute');

  precacheAndRoute(self.__WB_MANIFEST);

  // Set up asset cache
  registerRoute(
    ({ request }) => ['style', 'script', 'worker'].includes(request.destination),
    new StaleWhileRevalidate({
      cacheName: 'asset-cache',
      plugins: [
        new CacheableResponsePlugin({
          statuses: [0, 200],
        }),
      ],
    })
  );
  ```

  * üîë With workbox we need to first specify our `precacheAndRoute(self.__WB_MANIFEST);`.

  * üîë Next, we use workbox routing with a caching strategy to set up a cache called `asset-cache`.

* Open `28-Stu_Mini-Project/Main/client/webpack.config.js` in your IDE and explain the following:

  * We have our `entry` files set up so now we can specify the `output` files, as shown below:

  ```js
  output: {
      filename: '[name].bundle.js',
      path: path.resolve(__dirname, 'dist'),
    },
  ```

  * The files will be bundled and placed in the `dist` directory.

  * Next, we specify the `plugins` we want to use, as shown in the following:

  ```js
  plugins: [
    new HtmlWebpackPlugin({
      template: './index.html',
    }),
    
    new InjectManifest({
      swSrc: './src-sw.js',
      swDest: 'src-sw.js',
    }),
    new WebpackPwaManifest({
      fingerprints: false,
      inject: true,
      name: 'Contact Cards',
      short_name: 'Contact',
      description: 'Never forget your contacts!',
      background_color: '#225ca3',
      theme_color: '#225ca3',
      start_url: '/',
      publicPath: '/',
      icons: [
        {
          src: path.resolve('src/images/logo.png'),
          sizes: [96, 128, 192, 256, 384, 512],
          destination: path.join('assets', 'icons'),
        },
      ],
    }),
  ],
  ```

  * `HtmlWebpackPlugin` helps us generate an `index.html` file inside the `dist` directory.

  * `InjectManifest` will inject our custom service worker into our webpack build.

  * `WebpackPwaManifest` will create a `manifest.json` file with the provided object.

  * Finally, we can add CSS loaders and Babel, as shown below:

  ```js
  module: {
    rules: [
      {
        test: /\.css$/i,
        use: ['style-loader', 'css-loader'],
      },
      {
        test: /\.m?js$/,
        exclude: /node_modules/,
        use: {
          loader: 'babel-loader',
          options: {
            presets: ['@babel/preset-env'],
            plugins: ['@babel/plugin-proposal-object-rest-spread', '@babel/transform-runtime'],
          },
        },
      },
    ],
  },
  ```

* Open `28-Stu_Mini-Project/Main/client/assets/js/database.js` in your IDE and explain the following:

  * Here, we initialize the database and create an object store named `contacts`, as shown in the following:

  ```js
  const initdb = async () =>
    openDB('contact', 1, {
      upgrade(db) {
        if (db.objectStoreNames.contains('contact')) {
          console.log('contact database already exists');
          return;
        }
        db.createObjectStore('contact', { keyPath: 'id', autoIncrement: true });
        console.log('contact database created');
      },
    });
  ```

  * Next, we create a POST function for our database, as shown in the following:

  ```js
  export const postDb = async (name, home, cell, email)  => {
    const contactDb = await openDB('contact', 1);
    const tx = contactDb.transaction('contact', 'readwrite');
    const store = tx.objectStore('contact');
    const request = store.add({ name: name, home_phone: home, cell_phone: cell, email: email });
    const result = await request;
    console.log('üöÄ - data saved to the database', result);
  };
  ```

  * We open up a transaction in the `contact` database with `readwrite` privileges.

  * Once open, we use the `.add()` method on the `store` and pass in the appropriate parameters.

  * Next, we create a GET function for our database, as shown in the following:

  ```js
  export const getDb = async () => {
    const contactDb = await openDB('contact', 1);
    const tx = contactDb.transaction('contact', 'readonly');
    const store = tx.objectStore('contact');
    const request = store.getAll();
    const result = await request;
    console.log('result.value', result);
    return result;
  };
  ```

  * Same as earlier, except that we are using the `.getAll()` method instead which only requires `readonly` privileges.

  * Finally, we create a DELETE function for our database, as shown in the following:

  ```js
  export const deleteDb = async (id) => {
    const contactDb = await openDB('contact', 1);
    const tx = contactDb.transaction('contact', 'readwrite');
    const store = tx.objectStore('contact');
    const request = store.delete(id);
    const result = await request;
    console.log('result.value', result);
    return result?.value;
  };
  ```

* Same as earlier, except that we are using the `.delete()` method with the appropriate `id`.

* Open `28-Stu_Mini-Project/Main/client/.npmrc` in your IDE and explain the following:

  * üîë This tells Heroku to not purge our dev dependencies when we deploy to Heroku. We need a webpack for our application to work properly which is a dev dependency.

  * üîë Run the following commands to deploy to Heroku:

  ```sh
  git init
  git add -A
  git commit -m "Ready to deploy!"
  heroku create
  git push heroku main
  ```

  * üîë After a couple of minutes, our PWA should be successfully deployed to Heroku!

* Ask the class the following questions (‚òùÔ∏è) and call on students for the answers (üôã):

  * ‚òùÔ∏è Why do we want to deploy with the dev dependencies?

  * üôã We need access to webpack which is a dev dependency!

  * ‚òùÔ∏è Why do we use `concurrently`?

  * üôã So that we can run both the webpack server and node server during development.

  * ‚òùÔ∏è What can we do if we don't completely understand this?

  * üôã We can refer to supplemental material, read the [Heroku Deployment](https://devcenter.heroku.com/articles/git), and stick around for office hours to ask for help.

* Answer any questions before proceeding to the next activity.

### 16. Instructor Demo: Introduce Homework (5 min)

* Navigate to `02-Homework/Main` from the command line and run `npm install` and `npm run start`.

* Open <http://localhost:3000> in your browser and demonstrate the following:

  * We are building a PWA text editor with JavaScript syntax highlighting

* Try a simple `console.log()` in the editor to demonstrate the following:

  * Now we can click on the install button and it saves whatever we typed.

* Open the `Application` tab in Chrome Dev Tools. Under the `Cache Storage` section and inspect the contents of the object-store.

  * We are storing the contents of the editor in IndexedDB and saving `onBlur()` on the window.

  * We can also inspect the service worker which is caching our static assets so the application can work offline.

  * All of this is bundled with the help of a webpack!

* Ask the class the following questions (‚òùÔ∏è) and call on students for the answers (üôã):

  * ‚òùÔ∏è What are we learning?

  * üôã PWAs, webpack, workbook, and IndexedDB!

  * ‚òùÔ∏è How does this project build off or extend previously learned material?

  * üôã We get to apply the PUT method and we use a more complex `index.html` template.

  * ‚òùÔ∏è How does this project relate to your career goals?

  * üôã You get to flex some of your usual JavaScript skills with a hint of web performance!

* Ask TAs to direct students to the Homework Requirements found in `02-Homework/README.md`.

* Answer any questions before ending the class.

### 17. END (0 min)

How did today‚Äôs lesson go? Your feedback is important. Please take 5 minutes to complete this [anonymous survey](https://forms.gle/RfcVyXiMmZQut6aJ6).

---
¬© 2021 Trilogy Education Services, LLC, a 2U, Inc. brand. Confidential and Proprietary. All Rights Reserved.

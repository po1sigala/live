## 17.2 Lesson Plan - Riding with Mongoose (6:30 PM) <!--links--> &nbsp; [⬅️](../01-Day/01-Day-LessonPlan.md) &nbsp; [➡️](../03-Day/03-Day-LessonPlan.md)

### Overview

In the class, you will introduce students to Mongoose, a node package that provides a schema-based solution to model your Node application data. It includes built-in type casting, validation, query building, business logic hooks and more, out of the box.

* [Supplemental Content](../../../../01-Class-Content/18-mongo-new/03-Supplemental)

### Sample Class Video (Highly Recommended)

- To view an example class lecture visit (Note video may not reflect latest lesson plan): [Class Video](https://codingbootcamp.hosted.panopto.com/Panopto/Pages/Viewer.aspx?id=baba13c8-eb9d-4596-b261-df9063aaa9a8)

---

### Class Objectives

* Students will be able to:

  * Create a Mongoose schema to dictate rules for their MongoDB data.

  * Create custom methods in Mongoose to set and update data purely on the back end.

  * Implement Mongoose CRUD methods to create, read, update and delete data.

  * Utilize Mongoose's populate method to create relationships between the collections in their database.

---

### 1. Student Do: Warm up (10 mins)

* Start class with a quick review by opening up [08-Stu-Mongojs-Review/Solved/server.js](../../../../01-Class-Content/17-noSQL/01-Activities/08-Stu-Mongojs-Review/Solved/server.js) on your machine. Run `npm install` then `node server.js` to launch the application.

![Book Tracker](Images/08-Booktracker.png)

* Demonstrate to the students how the app lets you add books as well as mark books read or unread.

* Note the fact that an explicit route for the root, `http://localhost:3000` does not exist. However, the page still loads `index.html` from the `/public` folder. 

* Explain to the students that this is a convention from the static middleware that we are using. 

  * Point to this line: `app.use(express.static("public"));`

* Tell the class:
  
  * Your goal is to complete the routes in the server file so the site can display and edit the book data. Don't worry about the front end, just use MongoJS to finish the routes.

* Next direct the students towards the activity located in [08-Stu-Mongojs-Review/Unsolved/server.js](../../../../01-Class-Content/17-noSQL/01-Activities/08-Stu-Mongojs-Review/Unsolved/server.js)

* **Instructions**

  * Complete the routes in the server file so the site can display and edit the book data. 

### 2. Instructor Do: Go Over Warm Up (5 mins)

* Open [08-Stu-Mongojs-Review/Solved/server.js](../../../../01-Class-Content/17-noSQL/01-Activities/08-Stu-Mongojs-Review/Solved/server.js) and scroll down to the routes.

```js
app.post("/submit", ({ body }, res) => {
  const book = body;

  book.read = false;

  db.books.save(book, (error, saved) => {
    if (error) {
      console.log(error);
    } else {
      res.send(saved);
    }
  });
});

app.get("/read", (req, res) => {
  db.books.find({ read: true }, (error, found) => {
    if (error) {
      console.log(error);
    } else {
      res.json(found);
    }
  });
});

app.get("/unread", (req, res) => {
  db.books.find({ read: false }, (error, found) => {
    if (error) {
      console.log(error);
    } else {
      res.json(found);
    }
  });
});

app.put("/markread/:id", ({ params }, res) => {
  db.books.update(
    {
      _id: mongojs.ObjectId(params.id)
    },
    {
      $set: {
        read: true
      }
    },

    (error, edited) => {
      if (error) {
        console.log(error);
        res.send(error);
      } else {
        console.log(edited);
        res.send(edited);
      }
    }
  );
});

app.put("/markunread/:id", ({ params }, res) => {
  db.books.update(
    {
      _id: mongojs.ObjectId(params.id)
    },
    {
      $set: {
        read: false
      }
    },

    (error, edited) => {
      if (error) {
        console.log(error);
        res.send(error);
      } else {
        console.log(edited);
        res.send(edited);
      }
    }
  );
});
```

* Take the time to work through each route, helping students understand what each line is doing.

* When you are done, take any clarifying questions and move on to the next demonstration.

### 3. Instructor Do: Introduce Mongoose (10 mins)

* Tell the class that they are now going to be introduced to Mongoose, an Object Data Modeling (ODM) library for Mongo and Node. Mongoose lets you define schemas for your collections, which are then enforced at the ODM layer. It also helps manage relationships between data, provides validations and overall makes it easier to work with Node and Mongo.

*  Before we get started let's quickly cover a few key terms and how they relate to Mongoose.

  * Database — can contain one or more collections.

  * Collection — can contain one or more documents.

  * Document —  a key/value pair list or array of nested documents.

  * Schema — data structure of a document.

  * Model —  constructor that takes a specific schema and creates an instance of a document. Models are responsible for creating and reading documents.


* Next open [09-Ins-SchemaExample/server.js](../../../../01-Class-Content/17-noSQL/01-Activities/09-Ins-SchemaExample/server.js) in your editor and step through the code used to create our first mongo connection and schema.

  ```js
  // require the mongoose package
  const mongoose = require("mongoose");

  // require our schema 
  const Example = require("./exampleModel.js"); // Tell the class we will look at this file next

  // open a connection to the schemaexample database on our locally running instance of MongoDB
  mongoose.connect("mongodb://localhost/schemaexample", { useNewUrlParser: true });

  // create some data
  const data = {
    array: ["item1", "item2", "item3"],
    boolean: false,
    string:
      "We are learning mongoose!",
    number: 42
  };

  // call create on our Example schema and pass in our data
  Example.create(data)
    .then(dbExample => {
      console.log(dbExample);
    })
    .catch(({ message }) => {
      console.log(message);
    });
  ```

* Now open [09-Ins-SchemaExample/exampleModel.js](../../../../01-Class-Content/17-noSQL/01-Activities/09-Ins-SchemaExample/exampleModel.js) in your editor.

* Tell the class that Mongoose models are similar to those in sequelize. We define a schema for the model and then use the model to query our database. 

* Let's take a look at a our example schema by stepping through each line.

  ```js
  import mongoose from "mongoose";

  // set up a reference to Schema
  const Schema = mongoose.Schema;

  // create a new schema called ExampleSchema
  const ExampleSchema = new Schema({
    string: {
      type: String,
      trim: true,
      required: "String is Required" // validator
    },

    number: {
      type: Number,
      unique: true, // this is not a validator, but a built in helper
      required: true // validator
    },

    email: {
      type: String,
      match: [/.+@.+\..+/, "Please enter a valid e-mail address"]
    },

    boolean: Boolean,

    array: Array,

    date: {
      type: Date,
      default: Date.now
    },

    longstring: {
      type: String,
      validate: [({ length }) => length >= 6, "Longstring should be longer."]
    }
  });
  
  // compile our schema into a Model
  const Example = mongoose.model("Example", ExampleSchema);

  export default Example;
  ```

* Tell the class that all schema types have the built-in `required` validator. 

* Point out that numbers have `min` and `max` validators while strings have `enum`, `match`, `minlength`, and `maxlength` validators.

* Take any clarifying questions before moving on to the students activity.

### 4. Student Do: Make a Model Schema (15 mins)

* Open [10-Stu-User-Schema/Solved/userModel.js](../../../../01-Class-Content/17-noSQL/01-Activities/10-Stu-User-Schema/Solved/userModel.js) on your machine and run `npm install` then `node server.js` to launch the app. 

![New User](Images/10-Newuser.png)

* Create a new user and demonstrate the response.

  ```js
  {
    "_id": "5cfab6403da88328fcc7ac39",
    "username": "demo",
    "password": "demo",
    "email": "demo@gmail.com",
    "userCreated": "2019-06-07T19:08:48.294Z",
    "__v": 0
  }

  ```

* Try to create another user with the same email to demonstrate the validations.

  ```js
  {
    "driver": true,
    "name": "MongoError",
    "index": 0,
    "code": 11000,
    "errmsg": "E11000 duplicate key error collection: userdb.users index: email_1 dup key:  {: \"demo@gmail.com\" }"
  }
  ```

* Next, direct students towards the activity located in [10-Stu-User-Schema/Unsolved/userModel.js](../../../../01-Class-Content/17-noSQL/01-Activities/10-Stu-User-Schema/Unsolved/userModel.js)

* **Instructions**

  * In `userModel.js` add four attributes to your schema.

    * username: A string that will be be required, and also trimmed.

    * password: A string that will be required, trimmed, and at least 6 characters.

    * email: A string that must be a valid email address and unique in our collection.

    * userCreated: A date that will default to the current date.

  * **Hint**

  * The regex for checking if a string is an email is: /.+\@.+\..+/

### 5. Instructor Do: Review User Schema (5 mins)

* Open [10-Stu-User-Schema/Solved/userModel.js](../../../../01-Class-Content/17-noSQL/01-Activities/10-Stu-User-Schema/Solved/userModel.js) in your editor.

* Ask for a volunteer to help you fill out the schema.

```js
const mongoose = require("mongoose");
const Schema = mongoose.Schema;

const UserSchema = new Schema({
  username: {
    type: String,
    trim: true,
    required: "Username is Required"
  },

  password: {
    type: String,
    trim: true,
    required: "Password is Required",
    validate: [({ length }) => length >= 6, "Password should be longer."]
  },

  email: {
    type: String,
    unique: true,
    match: [/.+@.+\..+/, "Please enter a valid e-mail address"]
  },

  userCreated: {
    type: Date,
    default: Date.now
  }
});
```

* Make sure to review each attribute, checking for understanding. 

* Students may be confused with `match`, explain that it uses a regular expersion to check for a valid email address.

* When you are done, take any additional questions students may have before moving on.

---

### 6. Break (15 mins)

---

### 7. Instructor Do: Mongoose CRUD (10 mins)

* Tell the class that Mongoose models provide several helper functions for CRUD operations.

### 8. Student Do: Mongoose CRUD (10 mins)

### 9. Instructor Do: Review Mongoose CRUD (5 mins)

### 10. Instructor Do: Custom Methods (10 mins)

* Tell the class that Mongoose provides a way for us to create custom methods to manipluate our data.

* Change into [11-Ins-Custom-Methods](../../../../01-Class-Content/17-noSQL/01-Activities/11-Ins-Custom-Methods) and run `npm install` then `node server.js` to launch the app.

* Visit `localhost:3000` and fill out the form to create a new user and demo the response.

    ```js
    {
      "isCool": true,
      "_id": "5cfbbd607de1a557eeaaa056",
      "username": "test...the Coolest!",
      "password": "password1234",
      "email": "testuser@gmail.com",
      "userCreated": "2019-06-08T13:51:28.033Z",
      "__v": 0
    }
    ```

* Ask the class if they notice anything different about the data that was sent back.

* Point out that our new user has an  `isCool` field that is set to `true`.

* Open [11-Ins-Custom-Methods/userModel.js](../../../../01-Class-Content/17-noSQL/01-Activities/11-Ins-Custom-Methods/userModel.js) and scroll down to the custom methods.

  ```js
  UserSchema.methods.coolifier = function() {
    this.username = `${this.username}...the Coolest!`;
    return this.username;
  };

  UserSchema.methods.makeCool = function() {
    this.isCool = true;
    return this.isCool;
  };
  ```

  * Next open `server.js` and demonstrate how we are calling our methods on our new user.

  ```js
  app.post("/submit", ({ body }, res) => {
    const user = new User(body);
    user.coolifier(); // Bob...the Coolest!
    user.makeCool(); // isCool = true;

    User.create(user)
      .then(dbUser => {
        res.json(dbUser);
      })
      .catch(err => {
        res.json(err);
      });
  });
  ```

* Ask students if they have any questions before moving on.

### 11. Student Do: Methods (15 mins)

* Direct students to the next activity located in [12-Stu-Custom-Methods/Unsolved](../../../../01-Class-Content/17-noSQL/01-Activities/12-Stu-Custom-Methods/Unsolved)

* **Instructions**

* Open `userModel.js` and create the following custom methods.

  * `setFullName`: sets the current user's `fullName` property to their lastName appended to their `firstName`

  * `lastUpdatedDate`: sets the current user's `lastUpdated` property to `Date.now()`

* When you are finished use your new custom methods in a `POST` request.

### 12. Instructor Do: Review Methods (5 mins)

* Change into [12-Stu-Custom-Methods/Solved](../../../../01-Class-Content/17-noSQL/01-Activities/12-Stu-Custom-Methods/Solved) and open the `userModel.js` file.

* Ask for a volunteer to lead your through the custom methods they created.

* Next open `server.js` and ask for a volunteer to explain how to call these new methods in that file.

* Start the server and load up the site in your browser to demonstrate the form. 

* Take any clarifying questions before moving on.

### 13. Instructor Do: Mongoose Populate (10 mins)

* Change into [13-Ins-Populate](../../../../01-Class-Content/17-noSQL/01-Activities/13-Ins-Populate) and start the server with `node server.js`. 

* Then, visit `/books` to see your books listed.

```js
[{
    "_id": "5cfbc820bc851f678c714b2c",
    "author": "Herman Melville",
    "title": "Moby Dick",
    "__v": 0
}, {
    "_id": "5cfbc83ebc851f678c714b2d",
    "author": "F. Scott Fitzgerald",
    "title": "The Great Gatsby",
    "__v": 0
}]
```

* Then visit `/library` to see your library data listed in JSON, including a list of `ObjectIds` in the book property. These are the `ObjectIds` associated with each book we've made.

```js
[{
    "books": ["5cfbc510fff60b62b1a9c318", 
              "5cfbc51cfff60b62b1a9c319", 
              "5cfbc820bc851f678c714b2c", 
              "5cfbc83ebc851f678c714b2d"],
    "_id": "5cfbc29cfff60b62b1a9c317",
    "name": "Campus Library",
    "__v": 0
}]
```

* Ask students, what if we want to see the data for all of the books stored in our library. We could go back to books, but what if we want to include all of the information about our library and our books, and query that data with just one call.

  * Answer: This is where `Mongoose`'s populate method comes in. Open the `/populated` route in your browser, and go to the books property. All of the books will be there.

  ```js
  [{
      "books": [{
          "_id": "5cfbc820bc851f678c714b2c",
          "author": "Herman Melville",
          "title": "Moby Dick",
          "__v": 0
      }, {
          "_id": "5cfbc83ebc851f678c714b2d",
          "author": "F. Scott Fitzgerald",
          "title": "The Great Gatsby",
          "__v": 0
      }],
      "_id": "5cfbc29cfff60b62b1a9c317",
      "name": "Campus Library",
      "__v": 0
  }] 
  ```

* How does this happen?

  * Show them the `Library.js` model, and how it has a reference to the `Book.js` model inside it's schema.

    ```js
    const mongoose = require("mongoose");

    const Schema = mongoose.Schema;

    const LibrarySchema = new Schema({
      name: {
        type: String,
        unique: true
      },
      books: [
        {
          type: Schema.Types.ObjectId,
          ref: "Book"
        }
      ]
    });

    const Library = mongoose.model("Library", LibrarySchema);

    module.exports = Library;
    ```

  * Then show them the `index.js` file inside of the `models` folder.

    ```js
    module.exports = {
    Book: require("./Book"),
    Library: require("./Library")
    };
    ```

  * Explain that when working with multiple models, it's often useful to be able to require all of them at once, rather than individually. 
  
  * By exporting an object containing all of our models from the `index.js` file in the models folder, we can then require this object and access all of our models inside of `server.js`.

    ```js
    const db = require("./models");
    ```

  * Point out the `populate` method being used in `server.js`.

    ```js
    app.get("/populated", (req, res) => {
    db.Library.find({})
      .populate("books")
      .then(dbLibrary => {
        res.json(dbLibrary);
      })
      .catch(err => {
        res.json(err);
      });
    });
    ```

  * Explain that here we are running `populate("books")` after finding books and before handling the result of the query in `.then`.

  * Take any clarifying questions before moving on to the next activity.

### 14. Student Do: Mongoose Populate (15 mins)

* Direct students towards the next activity located in [14-Stu-Populate/Unsolved](../../../../01-Class-Content/17-noSQL/01-Activities/14-Stu-Populate/Unsolved)

* **Instructions**

  * Open `server.js` and update the `/populate` route to return `Users` populated with notes as JSON to the client.

* **Hint:** Check out the `Note.js` and `User.js` models to see how the schemas there make the populate method possible.

### 15. Instructor Do: Review Mongoose Populate (5 mins)

* Open up [14-Populate/Solved/server.js](../../../../01-Class-Content/17-noSQL/01-Activities/14-Stu-Populate/Solved/server.js).

* Ask for a volunteer to to walk you through the solution.

```js
app.get("/populateduser", (req, res) => {
  db.User.find({})
    .populate("notes")
    .then(dbUser => {
      res.json(dbUser);
    })
    .catch(err => {
      res.json(err);
    });
});
```

* Answer any clarifying questions before wrapping up.

### Lesson Plan Feedback

How did today's class go?

[Went Well](http://www.surveygizmo.com/s3/4325914/FS-Curriculum-Feedback?format=pt&sentiment=positive&lesson=18.03)

[Went Poorly](http://www.surveygizmo.com/s3/4325914/FS-Curriculum-Feedback?format=pt&sentiment=negative&lesson=18.03)

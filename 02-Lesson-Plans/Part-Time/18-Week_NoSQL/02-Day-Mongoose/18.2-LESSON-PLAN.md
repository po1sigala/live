# 18.2 Part-Time Lesson Plan: Introduction to Mongoose

## Overview

In the class, you will introduce students to Mongoose, a node package that provides a schema-based solution to model your Node application data.

## Instructor Notes

* In this lesson, students will complete activities `11-Ins_Models-Schemas` through `20-Stu_Aggregates`.

* @TODO Every Instructor Notes block begins with the preceding bullet, which outlines the activities that will be covered during class.

* @TODO Empathize with the instructor. If you only had one hour to prepare for class, what are the things you would want to know up front? What are the potential pitfalls in class? Where are students going to get hung up?

* @TODO Set the instructor up for success.

* Remind students to do a `git pull` of the class repo to have today's activities ready and open in VS Code.

* If you are comfortable doing so, live-code the solutions to the activities. If not, just use the solutions provided and follow the prompts and talking points for review.

* Let students know that the Bonus at the end of each activity is not meant to be extra coding practice, but instead is a self-study on topics beyond the scope of this unit for those who want to further their knowledge.

## Learning Objectives

By the end of class, students will be able to:

* Define the structure of the database with schema and use validators

* Create a model to map to the MongoDB document

* Execute CRUD queries using Mongoose

* Explain how instance methods are methods that perform some action on a specific instance of a Model

* Create and manipulate a document that is nested within another document

* Access MongoDB's aggregate framework through Mongoose

## Time Tracker

| Start  | #   | Activity Name                        | Duration |
|---     |---  |---                                   |---       |
| 6:30PM | 1   | Instructor Do: Stoke Curiosity       | 0:10     |
| 6:40PM | 2   | Instructor Demo: Models and Schema   | 0:05     |
| 6:45PM | 3   | Student Do: Models and Schema        | 0:15     |
| 7:00PM | 4   | Instructor Review: Models and Schema | 0:10     |
| 7:10PM | 5   | Instructor Demo: CRUD Mongoose       | 0:05     |
| 7:15PM | 6   | Student Do: CRUD Mongoose            | 0:15     |
| 7:30PM | 7   | Instructor Review: CRUD Mongoose     | 0:10     |
| 7:40PM | 8   | Instructor Demo: Instance Method     | 0:05     |
| 7:45PM | 9   | Student Do: Instance Method          | 0:15     |
| 8:00PM | 10  | BREAK                                | 0:15     |
| 8:15PM | 11  | Instructor Review: Instance Method   | 0:10     |
| 8:25PM | 12  | Instructor Demo: Subdocuments        | 0:05     |
| 8:30PM | 13  | Student Do: Subdocuments             | 0:15     |
| 8:45PM | 14  | Instructor Review: Subdocuments      | 0:10     |
| 8:55PM | 15  | Instructor Demo: Aggregates          | 0:05     |
| 9:00PM | 16  | Student Do: Aggregates               | 0:15     |
| 9:15PM | 17  | Instructor Review: Aggregates        | 0:15     |
| 9:30PM | 18  | END                                  | 0:00     |

> **Important**: If this lesson occurs on a Saturday, make sure to adjust the activities to accommodate for the extra hour of class time. Feel free to take your time as you go through the activities; for example, you can add 5 minutes to the `Student Do` and `Instructor Review` sections as you see fit. Remember to take a 40-minute break at noon!

---

## Class Instruction

### 1. Instructor Do: Stoke Curiosity (10 min)

* Welcome students to class.

* @TODO The first building block of every class is used to stoke curiosity on the topic. Refer to the Activity Planner for the Stoke Curiosity activity.

### 2. Instructor Demo: Models and Schema (5 min)

* Open `11-Ins_Models-Schemas/config/connection.js` in your IDE and demonstrate the following:

  * Mongoose is an Object Data Modeling (ODM) library for MongoDB. Think of it like a wrapper around MongoDB that makes it easier to manage relationships between data. It's kind of like what Sequelize was for MySQL.

  * 🔑 In order to implement Mongoose we need to wrap it around our local connection to MongoDB. We use the `.connect()` method to accomplish this.

    ```js
    mongoose.connect('mongodb://localhost:27017/mygroceryDB', {
      useNewUrlParser: true,
      useUnifiedTopology: true,
      useCreateIndex: true,
      useFindAndModify: false,
    });
    ```

  * You'll notice some options we are using in our `connect()` method. Those are not crucial to understand but if you want to know more about it, you can check out the [Mongoose docs on Connections](https://mongoosejs.com/docs/connections.html#options).

* Open `11-Ins_Models-Schemas/models/Item.js` in your IDE and demonstrate the following:

  * 🔑 Next, we need to define a schema for our model. Everything in Mongoose starts with a Schema. Each schema maps to a MongoDB collection and defines the shape of the documents in that collection.

    ```js
    const grocerySchema = new mongoose.Schema({
      item: { type: String, required: true },
      stockCount: Number,
      price: Number,
      inStock: Boolean,
      // Use built in date method to get current date
      lastAccessed: { type: Date, default: Date.now },
    });
    ```

  * Each key in the `grocerySchema` defines a property in our documents that will be cast to its associated `SchemaType`. For example, `item` is a property with the `String` SchemaType. It is also using a built-in validator, `required`, which means this property must exist in order for the instance to be created.

    ```js
    item: { type: String, required: true }
    ```

  * Notice that `Number` and `Boolean` is shorthand for `{type: Number}` and `{type: Boolean}`.

    ```js
    price: Number,
    inStock: Boolean,
    ```

  * 🔑 Now that we have our schema set up, we can compile our model. When we call the `model()` method on our schema, Mongoose will compile a model for us!

    ```js
    const Item = mongoose.model('Item', grocerySchema);
    ```

  * The first argument of the `model()` method is the singular name of the collection our model is for, which in our case is `Item`. Mongoose will look for the plural, lowercase version of the model name as the collection in our database, which in our case will be `items`.

  * The second argument of the `model()` method is the schema we are using, which is `grocerySchema`.

  * 🔑 Now to create a new document, we will use the `.create()` method on our model. We are using the model to create individual documents that have the properties as defined in our schema.

    ```js
    Item.create(
      {
        item: 'banana',
        stockCount: 10,
        price: 1,
        inStock: true,
      },
      (err) => (err ? handleError(err) : console.log('Created new document'))
    );
    ```

* Open `11-Ins_Models-Schemas/server.js` in your IDE and demonstrate the following:

  * We need to require our `Item` model at the top of the file.

    ```js
    const { Item } = require('./models');
    ```

  * 🔑 In our GET route, we are using the model to `.find()` all documents that are instances of that model.

    ```js
    app.get('/all-items', (req, res) => {
      Item.find({}, (err, result) => {
        if (err) {
          res.status(500).send({ message: 'Internal Server Error' });
        } else {
          res.status(200).json(result);
        }
      });
    });
    ```

  * We are using the `.find()` method on our `Item` model inside the GET route.

* Ask the class the following questions (☝️) and call on students for the answers (🙋):

  * ☝️ How would we build this?

  * 🙋 We would need to create a schema first that defines the properties. Then we would compile our model. Finally we will create new documents off of our model.

* Answer any questions before proceeding to the next activity.

* In preparation for the activity, ask TAs to start directing students to the activity instructions found in `12-Stu_Models-Schemas/README.md`.

### 3. Student Do: Models and Schema (15 min)

* Direct students to the activity instructions found in `12-Stu_Models-Schemas/README.md`.

* Break your students into pairs that will work together on this activity.

  ```md
  # 📐 Add Comments to Implementation of Models and Schemas With Mongoose

  Work with a partner to add comments describing the functionality of the code found in [models/Book.js](./Unsolved/models/Book.js) and [server.js](./Unsolved/server.js).

  ## 📝 Notes

  Refer to the documentation:

  [Mongoose Docs on Models](https://mongoosejs.com/docs/models.html)

  [Mongoose Docs on Schemas](https://mongoosejs.com/docs/guide.html)

  [Mongoose Docs on Validation](https://mongoosejs.com/docs/validation.html)

  ---

  ## 🏆 Bonus

  If you have completed this activity, work through the following challenge with your partner to further your knowledge:

  * How can you design a custom validator using a validation function to suit your data's needs?

  Use [Google](https://www.google.com) or another search engine to research this.
  ```

* While breaking everyone into groups, be sure to remind students and the rest of the instructional staff that questions on Slack or otherwise are welcome and will be handled. It's a good way for your team to prioritize students who need extra help.

### 4. Instructor Review: Models and Schema (10 min)

* Ask the class the following questions (☝️) and call on students for the answers (🙋):

  * ☝️ How comfortable do you feel with Mongoose Models and Schema? (Poll via Fist to Five, Slack, or Zoom)

* Assure students that we will cover the solution to help solidify their understanding. If questions remain, remind them to use office hours to get extra help!

* Use the prompts and talking points (🔑) below to review the following key points:

  * ✔️ `mongoose.Schema()`

  * ✔️ `mongoose.model()`

  * ✔️ `.create()`

  * ✔️ `.find()`

* Open `12-Stu_Models-Schemas/Solved/models/Book.js` in your IDE and explain the following:

  * 🔑 First we are creating our `bookSchema`. We use the `Schema()` method to define our `bookSchema`. We specify the `SchemaType` and use validation to specify which properties are required.

    ```js
    const bookSchema = new mongoose.Schema({
      title: { type: String, required: true },
      author: { type: String, required: false },
      publisher: String,
      stockCount: Number,
      price: Number,
      inStock: Boolean,
      lastAccessed: { type: Date, default: Date.now },
    });
    ```

  * 🔑 Next, we compile a model based on our `bookSchema`.

    ```js
    const Book = mongoose.model('Book', bookSchema);
    ```

  * 🔑 We create a new instance of the `Book` model. This instance includes all of the properties outlined in our schema.

    ```js
    Book.create(
      {
        title: 'Diary of Anne Frank',
        author: 'Anne Frank',
        publisher: 'Scholastic',
        stockCount: 10,
        price: 10,
        inStock: true,
      },
      (err) => (err ? handleError(err) : console.log('Created new document'))
    );
    ```

  * But the next instance only includes the `title` which is required, and the `author` which isn't required.

    ```js
    Book.create(
      { title: 'Oh the Places You Will Go!', author: 'Dr. Seuss' },
      (err) => (err ? handleError(err) : console.log('Created new document'))
    );
    ```

  * The last instance simply includes only the required property, which was `title`

    ```js
    Book.create({ title: 'Harold and the Purple Crayon' }, (err) =>
      err ? handleError(err) : console.log('Created new document')
    );
    ```

  * This is a good example of the flexibility you have with NoSQL databases and how validators can come in handy.

* Open `12-Stu_Models-Schemas/Solved/server.js` in your IDE and explain the following:

  * First, we need to import our `Book` model.

    ```js
    const { Book } = require('./models');
    ```

  * Next, in our GET route, we are using the `.find()` method on our `Book` model to find all books in our collection.

    ```js
    app.get('/all-books', (req, res) => {
      Book.find({}, (err, result) => {
        if (err) {
          res.status(500).send({ message: 'Internal Server Error' });
        } else {
          res.status(200).json(result);
        }
      });
    });
    ```

* Navigate to `12-Stu_Models-Schemas/Solved` in your command line and run the application.

* Open `localhost:3001/all-books` in your browser and demonstrate the following:

  * We see all of our books returned in JSON format. Every book instance has a title since it was required, but the other properties were optional.

* Ask the class the following questions (☝️) and call on students for the answers (🙋):

  * ☝️ What are some other Mongoose built-in validators?

  * 🙋 Numbers have `min` and `max` validators. Strings have `enum`, `match`, `minLength`, and `maxLength` validators.

  * ☝️ What can we do if we don't completely understand this?

  * 🙋 We can refer to supplemental material, read the [Mongoose Docs on Schemas](https://mongoosejs.com/docs/guide.html#definition), and stick around for office hours to ask for help.

* Answer any questions before proceeding to the next activity.

### 5. Instructor Demo: CRUD Mongoose (5 min)

@TODO USE THE FOLLOWING FOR BROWSER AND/OR COMMAND LINE DEMOS, RESPECTIVELY. REMOVE IF UNUSED

* Open `13-Ins_CRUD-Mongoose/models/Item.js` in your IDE and demonstrate the following:

  * When we execute CRUD operations with Mongoose, we will see how similar they are to regular MongoDB CRUD methods.

  * 🔑 When we create a new instance of a model, we can use `.create()` or `.save()`. We used `.create()` to create a document of the `Item` model.

    ```js
    Item.create(
      {
        item: 'banana',
        stockCount: 10,
        price: 1,
        inStock: true,
      },
      (err) => (err ? handleError(err) : console.log('Created new document'))
    );
    ```

    * But another way to create a document is to use the `.save()` method.

* Open `13-Ins_CRUD-Mongoose/server.js` in your IDE and demonstrate the following:

  * 🔑 We see a POST request being made to create a new `Department`. We will take the name of the new department from the params. Notice we are using the `.save()` method to create this new document.

    ```js
    app.post('/new-department/:department', (req, res) => {
      const newDepartment = new Department({ name: req.params.department });
      newDepartment.save();
      if (newDepartment) {
        res.status(201).json(newDepartment);
      } else {
        console.log('Uh Oh, something went wrong');
        res.status(500).json({ error: 'Something went wrong' });
      }
    });
    ```

  * 🔑 We know we can use the `.find()` method to query the database to find all documents that are instances of that model, but Mongoose also provides static helper functions for CRUD operations. If we want to find one specific document, we can use the `.findOne()` method.

    ```js
    app.get('/find-wine-department', (req, res) => {
      Department.findOne({ name: 'Wine' }, (err, result) => {
        if (result) {
          res.status(200).json(result);
        } else {
          console.log('Uh Oh, something went wrong');
          res.status(500).json({ error: 'Something went wrong' });
        }
      });
    });
    ```

  * In the preceding code block, we can see a GET route to find the wine department. We are using the `.findOne()` method on the `Department` model and hardcoding the name of the department as "Wine" for now. This will return the first document with the name "Wine".

  * 🔑 Another helper function we can use for CRUD operations is the `.findOneAndDelete()`. This will find the document and delete it from the database. This time instead of hardcoding the name, we will use the params.

    ```js
    app.delete('/find-one-delete/:departmentName', (req, res) => {
      Department.findOneAndDelete(
        { name: req.params.departmentName },
        (err, result) => {
          if (result) {
            res.status(200).json(result);
            console.log(`Deleted: ${result}`);
          } else {
            console.log('Uh Oh, something went wrong');
            res.status(500).json({ error: 'Something went wrong' });
          }
        }
      );
    });
    ```

  * In the preceding code block, we see a DELETE route to find one department and delete it. The `.findOneAndDelete()` method will take in the name of the department from the params, query the database, and delete that document.

  * Now that we've seen the code, let's test these routes in Insomnia.

* Run `npm install` and `npm start` to start the application. Open Insomnia and demonstrate the following:

  * First, let's try to create a new department. We will make a POST request to `localhost:3001/new-department/Snacks` to create a new Snacks department in Insomnia. If the request is successful, we should get the new document returned, similar to the following:

    ```json
    {
      "_id": "611d1fc95db4d4153d5d11fe",
      "name": "Snacks",
      "lastAccessed": "2021-08-18T14:57:13.184Z"
    }
    ```

  * Next, let's find the first "Wine" document. We will make a GET request to `localhost:3001/find-wine-department` in Insomnia. If the request is successful, we should get the first "Wine" document returned, similar to the following:

    ```json
    {
      "_id": "6115cecd9da5b53b2ac2e0d3",
      "name": "Wine",
      "lastAccessed": "2021-08-13T01:45:49.653Z",
      "__v": 0
    }
    ```

  * Finally, let's delete the Snacks department we just created. We will make a DELETE request to `localhost:3001/find-one-delete/Snacks` in Insomnia. If the request is successful, we should get the deleted Snacks department returned, similar to the following:

    ```json
    {
      "_id": "611d1fc95db4d4153d5d11fe",
      "name": "Snacks",
      "lastAccessed": "2021-08-18T14:57:13.184Z",
      "__v": 0
    }
    ```

* Ask the class the following questions (☝️) and call on students for the answers (🙋):

  * ☝️ How would we build this?

  * 🙋 We can check the [Mongoose Docs on queries](https://mongoosejs.com/docs/queries.html) to use the helper functions for CRUD operations.

* Answer any questions before proceeding to the next activity.

* In preparation for the activity, ask TAs to start directing students to the activity instructions found in `14-Stu_CRUD-Mongoose/README.md`.

### 6. Student Do: CRUD Mongoose (15 min)

* Direct students to the activity instructions found in `14-Stu_CRUD-Mongoose/README.md`.

* Break your students into pairs that will work together on this activity.

  ```md
  # 📖 Implement CRUD Operations with Mongoose

  Work with a partner to implement the following user story:

  * As a developer, I want to be able to find a single document and update it using a Mongoose CRUD method.

  ## Acceptance Criteria

  * It's done when I use a Mongoose CRUD method to select a single document with the `name` property of `Kids` and update it.

  * It's done when the updated document has an updated `name` property value that matches the value provided in the route parameter.

  * It's done when only the `name` property has been updated in the document and no other changes have been made.

  * It's done when I test the `POST` Route in Insomnia and the updated document is returned.

  ## 📝 Notes

  Refer to the documentation:

  [Mongoose docs on findOneAndUpdate()](https://mongoosejs.com/docs/tutorials/findoneandupdate.html)

  ---

  ## 💡 Hints

  * How can you add an option to your Mongoose CRUD method so that the updated object is returned?

  ## 🏆 Bonus

  If you have completed this activity, work through the following challenge with your partner to further your knowledge:

  * What is the difference between `insert()`, `insertMany()` or `create()`? Why would you want to use one method over the other?

  Use [Google](https://www.google.com) or another search engine to research this.
  ```

* While breaking everyone into groups, be sure to remind students and the rest of the instructional staff that questions on Slack or otherwise are welcome and will be handled. It's a good way for your team to prioritize students who need extra help.

### 7. Instructor Review: CRUD Mongoose (10 min)

* Ask the class the following questions (☝️) and call on students for the answers (🙋):

  * ☝️ How comfortable do you feel with CRUD operations in Mongoose? (Poll via Fist to Five, Slack, or Zoom)

* Assure students that we will cover the solution to help solidify their understanding. If questions remain, remind them to use office hours to get extra help!

* Use the prompts and talking points (🔑) below to review the following key points:

  * ✔️ `.findOneAndUpdate()`

* Open `14-Stu_CRUD-Mongoose/Solved/server.js` in your IDE and explain the following:

  * We had to find the document with the name "Kids" and update it to a different name of our choice. We were also given the Mongoose docs on how to use `.findOneAndUpdate()`.

  * 🔑 First, we use the `.findOneAndUpdate()` method on the `Department` model.

    ```js
    Genre.findOneAndUpdate(
    ```

  * The first parameter is the condition; what are we looking for? We are looking for the document with the name "Kids".

    ```js
    { name: 'Kids' },
    ```

  * The next parameter is update; what are we updating it to? We are updating the name to what the value of the URL param is.

    ```js
    { name: req.params.genre },
    ```

  * The last parameter is a bit tricky. We need to use an option to return the updated information, not the original document. To do that, we set the `new` option to `true`.

    ```js
    { new: true },
    ```

  * Finally we need to add the callback function that handles our errors and returns the updated document.

    ```js
    (err, result) => {
      if (result) {
        res.status(200).json(result);
        console.log(`Updated: ${result}`);
      } else {
        console.log('Uh Oh, something went wrong');
        res.status(500).json({ message: 'something went wrong' });
      }
    }
    ```

* Run `npm install` and `npm start` to start the application. Open Insomnia and demonstrate the following:

  * Let's make sure it works! We will make a POST request to `localhost:3001/find-one-update/History` to change the name of the genre to History, or whatever else you would like, in Insomnia.

  * If the request is successful, we should get the updated genre returned, similar to the following:

    ```json
    {
      "_id": "611d25f4886a0717e9d419d8",
      "name": "History",
      "lastAccessed": "2021-08-18T15:23:32.667Z",
      "__v": 0
    }
    ```

* Ask the class the following questions (☝️) and call on students for the answers (🙋):

  * ☝️ What are the two ways a Mongoose query can be executed?

  * 🙋 We can pass in a callback function which will allow Mongoose to execute the query asynchronously and pass the results to the callback. Or we can use `.then` and use the query as a promise.

  * ☝️ What can we do if we don't completely understand this?

  * 🙋 We can refer to supplemental material, read the [Mongoose Docs on queries](https://mongoosejs.com/docs/queries.html), and stick around for office hours to ask for help.

* Answer any questions before proceeding to the next activity.

### 8. Instructor Demo: Instance Method (5 min)

* Open `15-Ins_Models-Instance-Methods/models/Department.js` in your IDE and demonstrate the following:

  * 🔑 We use instance methods to perform some action on a specific instance. There are built-in instance methods with Mongoose as well as custom instance methods we can create.

  * First let's use a simple build-in instance method on a document. The `Department` model has the following schema:

    ```js
    const departmentSchema = new mongoose.Schema({
      name: { type: String, required: true },
      totalStock: Number,
      lastAccessed: { type: Date, default: Date.now },
    });

    const Department = mongoose.model('Department', departmentSchema);
    ```

  * Let's create a new instance of the Department called `produce`.

    ```js
    const produce = new Department({ name: 'Produce', totalStock: 100 });
    ```

  * 🔑 Let's use the built-in instance method `.get()` to get the `totalStock` of `produce`.

    ```js
    const responseGetInstance = produce.get('totalStock', String);
    console.log(
      `The value of the totalStock for this document in string form is ${responseGetInstance}`
    );
    ```

  * The instance method `.get()` takes in three parameters: the path, and two optional parameters, type and options. In our case, we are getting the value of `totalStock` and we want it returned as a `String`. We didn't use options in our case.

  * 🔑 We can also create our own custom instance methods. After defining our schema, we can define a custom method `getDocumentInfo` to the `methods` object of our schema.

    ```js
    departmentSchema.methods.getDocumentInfo = function () {
      console.log(
        `This department has the name ${this.name} and a total stock of ${this.totalStock}`
      );
    };
    ```

  * Now we can call `.getDocumentInfo()` on any of our `Department` instances!

    ```js
    produce.getDocumentInfo();
    ```

* Run `npm install` and `node models/Department.js` from your command line to demonstrate the following:

  * We see the response from the built-in instance method first.

    ```text
    The value of the totalStock for this document in string form is 100
    ```

  * Then we see the response from calling the `getDocumentInfo()` custom instance method on `produce`.

    ```text
    This department has the name Produce and a total stock of 100
    ```

* Ask the class the following questions (☝️) and call on students for the answers (🙋):

  * ☝️ How would we build this?

  * 🙋 We will need to define the schema, create a custom instance method on the schema, and run the custom method on an instance of the model.

* Answer any questions before proceeding to the next activity.

* In preparation for the activity, ask TAs to start directing students to the activity instructions found in `16-Stu_Models-Instance-Methods/README.md`.

### 9. Student Do: Instance Method (15 min)

* Direct students to the activity instructions found in `16-Stu_Models-Instance-Methods/README.md`.

* Break your students into pairs that will work together on this activity.

  ```md
  # 🏗️ Implement Instance Methods on a Mongoose Model

  Work with a partner to implement the following user story:

  * As a developer, I want to perform an action on a specific instance of a Mongoose model.

  ## Acceptance Criteria

  * It's done when I define a new schema named `bookSchema`.

  * It's done when the new schema has three properties: `title`, `author`, and `price`

  * It's done when I assign a function named `getDiscount` to the methods object of the `bookSchema` that reduces the price by 50 percent and console logs the title of the book and the reduced price.

  * It's done when I have created a model named `Book`.

  * It's done when I have created an instance of the model, or document, named `discountedBook`.

  * It's done when I test the instance method by running `Book.js`.

  * It's down when the price of `discountedBook` is reduced by 50 percent and the results logged to the console.

  ---

  ## 💡 Hints

  What is the difference between and instance method and a static method?

  ## 🏆 Bonus

  If you have completed this activity, work through the following challenge with your partner to further your knowledge:

  * How can you add query helper methods to extend Mongoose's chainable query builder API?

  Use [Google](https://www.google.com) or another search engine to research this.
  ```

* While breaking everyone into groups, be sure to remind students and the rest of the instructional staff that questions on Slack or otherwise are welcome and will be handled. It's a good way for your team to prioritize students who need extra help.

### 10. BREAK (15 min)

### 11. Instructor Review: Instance Method (10 min)

* Ask the class the following questions (☝️) and call on students for the answers (🙋):

  * ☝️ How comfortable do you feel with instance methods? (Poll via Fist to Five, Slack, or Zoom)

* Assure students that we will cover the solution to help solidify their understanding. If questions remain, remind them to use office hours to get extra help!

* Use the prompts and talking points (🔑) below to review the following key points:

  * ✔️ `.getDiscount()`

* Open `16-Stu_Models-Instance-Methods/Solved/models/Book.js` in your IDE and explain the following:

  * First we have to define a new schema named `bookSchema` that has three properties: `title`, `author`, and `price`.

    ```js
    const bookSchema = new mongoose.Schema({
      title: { type: String, required: true },
      author: String,
      price: { type: Number, required: true },
    });
    ```

  * 🔑 Next we created a custom instance method `.getDiscount()`. We assign it to the methods object of the `bookSchema`. This function will reduce the price by 50 percent and console logs the title and reduced price of the book.

    ```js
    bookSchema.methods.getDiscount = function () {
      const discountPrice = this.price * 0.5;
      console.log(
        `The book's title is ${this.title} and the discounted price is ${discountPrice}`
      );
    };
    ```

  * Then we create a model named `Book`.

    ```js
    const Book = mongoose.model('Book', bookSchema);
    ```

  * Then we create a new instance of the model called `discountedBook`. You could've named the book and price whatever you want.

    ```js
    const discountedBook = new Book({
      title: 'Oh the Places You Will Go!',
      price: 100,
    });
    ```

  * Finally, we called the `.getDiscount()` custom instance method on the instance.

    ```js
    discountedBook.getDiscount();
    ```

* Run `npm install` and `node models/Book.js` from the command line to demonstrate the following:

  * When we run the file, we see the discounted price of the book.

    ```text
    The book's title is Oh the Places You Will Go! and the discounted price is 50
    ```

* Ask the class the following questions (☝️) and call on students for the answers (🙋):

  * ☝️ @TODO { DO WE END OUR REVIEWS WITH A QUESTION? }

  * 🙋 @TODO { YES, WE DO! }

  * ☝️ What can we do if we don't completely understand this?

  * 🙋 @TODO We can refer to supplemental material, read the [{ DOCS }]({ URL }), and stick around for office hours to ask for help.

* Answer any questions before proceeding to the next activity.

### 12. Instructor Demo: Subdocuments (5 min)

@TODO USE THE FOLLOWING FOR BROWSER AND/OR COMMAND LINE DEMOS, RESPECTIVELY. REMOVE IF UNUSED

* Open `@TODO/folder/file` in your browser and demonstrate the following:

* Run `@TODO/folder/file { AND ARGS, IF ANY }` from the command line and demonstrate the following:

  * 🔑 @TODO { WHEN WE DO THIS, IT DOES THAT. }

  * 🔑 @TODO { WE ALSO SEE THESE THINGS. }

* Ask the class the following questions (☝️) and call on students for the answers (🙋):

  * ☝️ How would we build this?

  * 🙋 @TODO { YES, HOW? }

* Answer any questions before proceeding to the next activity.

* In preparation for the activity, ask TAs to start directing students to the activity instructions found in `@TODO/folder/file`.

### 13. Student Do: Subdocuments (15 min)

* Direct students to the activity instructions found in `@TODO/folder/file`.

* Break your students into pairs that will work together on this activity.

  ```md
  @TODO ADD ACTIVITY INSTRUCTIONS, TABBED ONCE OR TWICE (DEPENDING ON CODE SNIPPETS IN ACTIVITY INSTRUCTIONS)
  ```

* While breaking everyone into groups, be sure to remind students and the rest of the instructional staff that questions on Slack or otherwise are welcome and will be handled. It's a good way for your team to prioritize students who need extra help.

### 14. Instructor Review: Subdocuments (10 min)

* Ask the class the following questions (☝️) and call on students for the answers (🙋):

  * ☝️ How comfortable do you feel with @TODO { TOPIC }? (Poll via Fist to Five, Slack, or Zoom)

* Assure students that we will cover the solution to help solidify their understanding. If questions remain, remind them to use office hours to get extra help!

* Use the prompts and talking points (🔑) below to review the following key points:

  * ✔️ @TODO { THIS }

  * ✔️ @TODO { THAT }

  * ✔️ @TODO { THE OTHER }

* Open `@TODO/folder/file` in your IDE and explain the following:

  * @TODO { WE DO THIS AND THE RESULT IS THAT }

    ```
    @TODO ADD CODE SNIPPET, TABBED TWICE (4 SPACES)
    ```

  * 🔑 @TODO DON'T FORGET TO USE THE KEY EMOJI ON KEY POINTS, BUT ONLY KEY POINTS, NOT _EVERY_ POINT

* Ask the class the following questions (☝️) and call on students for the answers (🙋):

  * ☝️ @TODO { DO WE END OUR REVIEWS WITH A QUESTION? }

  * 🙋 @TODO { YES, WE DO! }

  * ☝️ What can we do if we don't completely understand this?

  * 🙋 @TODO We can refer to supplemental material, read the [{ DOCS }]({ URL }), and stick around for office hours to ask for help.

* Answer any questions before proceeding to the next activity.

### 15. Instructor Demo: Aggregates (5 min)

@TODO USE THE FOLLOWING FOR BROWSER AND/OR COMMAND LINE DEMOS, RESPECTIVELY. REMOVE IF UNUSED

* Open `@TODO/folder/file` in your browser and demonstrate the following:

* Run `@TODO/folder/file { AND ARGS, IF ANY }` from the command line and demonstrate the following:

  * 🔑 @TODO { WHEN WE DO THIS, IT DOES THAT. }

  * 🔑 @TODO { WE ALSO SEE THESE THINGS. }

* Ask the class the following questions (☝️) and call on students for the answers (🙋):

  * ☝️ How would we build this?

  * 🙋 @TODO { YES, HOW? }

* Answer any questions before proceeding to the next activity.

* In preparation for the activity, ask TAs to start directing students to the activity instructions found in `@TODO/folder/file`.

### 16. Student Do: Aggregates (15 min)

* Direct students to the activity instructions found in `@TODO/folder/file`.

* Break your students into pairs that will work together on this activity.

  ```md
  @TODO ADD ACTIVITY INSTRUCTIONS, TABBED ONCE OR TWICE (DEPENDING ON CODE SNIPPETS IN ACTIVITY INSTRUCTIONS)
  ```

* While breaking everyone into groups, be sure to remind students and the rest of the instructional staff that questions on Slack or otherwise are welcome and will be handled. It's a good way for your team to prioritize students who need extra help.

### 17. Instructor Review: Aggregates (15 min)

* Ask the class the following questions (☝️) and call on students for the answers (🙋):

  * ☝️ How comfortable do you feel with @TODO { TOPIC }? (Poll via Fist to Five, Slack, or Zoom)

* Assure students that we will cover the solution to help solidify their understanding. If questions remain, remind them to use office hours to get extra help!

* Use the prompts and talking points (🔑) below to review the following key points:

  * ✔️ @TODO { THIS }

  * ✔️ @TODO { THAT }

  * ✔️ @TODO { THE OTHER }

* Open `@TODO/folder/file` in your IDE and explain the following:

  * @TODO { WE DO THIS AND THE RESULT IS THAT }

    ```
    @TODO ADD CODE SNIPPET, TABBED TWICE (4 SPACES)
    ```

  * 🔑 @TODO DON'T FORGET TO USE THE KEY EMOJI ON KEY POINTS, BUT ONLY KEY POINTS, NOT _EVERY_ POINT

* Ask the class the following questions (☝️) and call on students for the answers (🙋):

  * ☝️ @TODO { DO WE END OUR REVIEWS WITH A QUESTION? }

  * 🙋 @TODO { YES, WE DO! }

  * ☝️ What can we do if we don't completely understand this?

  * 🙋 @TODO We can refer to supplemental material, read the [{ DOCS }]({ URL }), and stick around for office hours to ask for help.

* Answer any questions before ending the class.

### 18. END (0 min)

How did today’s lesson go? Your feedback is important. Please take 5 minutes to complete this [anonymous survey](https://forms.gle/RfcVyXiMmZQut6aJ6).

---
© 2021 Trilogy Education Services, LLC, a 2U, Inc. brand. Confidential and Proprietary. All Rights Reserved.
